<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Rebel Ribbon Staff UI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    .tab-active{border-bottom:2px solid #111;font-weight:600}
    .cell{padding:.75rem}
    .thcell{padding:.75rem;font-weight:600}
    .nowrap{white-space:nowrap}
    .table-wrap{overflow:auto;border-radius:.75rem;border:1px solid #e5e7eb;background:#fff}
    table{border-collapse:separate;border-spacing:0;table-layout:fixed}
    #orderPanel::backdrop{background:rgba(0,0,0,.35)}
    .btn{padding:.5rem .75rem;border-radius:.5rem;border:1px solid #e5e7eb;background:#fff}
    .btn-primary{background:#2563eb;color:#fff;border-color:#2563eb}
    .btn-danger{border-color:#ef4444;color:#b91c1c}
    .btn-ghost{background:transparent;border-color:transparent}
    .input{padding:.5rem .75rem;border:1px solid #e5e7eb;border-radius:.5rem}
    .card{border:1px solid #e5e7eb;border-radius:.75rem;background:#fff}
    .loader{animation:spin 1s linear infinite;display:inline-block;width:1rem;height:1rem;border:2px solid #f3f3f3;border-top:2px solid #3498db;border-radius:50%}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <!-- Sign in card -->
  <div id="signinCard" class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md bg-white rounded-2xl shadow p-6">
      <h1 class="text-2xl font-semibold mb-2">Rebel Ribbon Staff Sign in</h1>
      <p class="text-sm text-gray-600 mb-4">Use your @rebelribbon.com email. We'll send a magic link.</p>
      <label class="block text-sm mb-2">Email</label>
      <input id="email" type="email" placeholder="you@rebelribbon.com" class="w-full input"/>
      <button id="sendLink" type="button" class="w-full btn btn-primary mt-4 flex items-center justify-center">Send magic link <span id="sendLoader" class="loader hidden ml-2"></span></button>
      <p id="authMsg" class="text-sm mt-3"></p>
      <p class="text-xs text-gray-500 mt-3">If the button does nothing, check SUPABASE_URL and SUPABASE_ANON_KEY.</p>
    </div>
  </div>
  <!-- App shell -->
  <div id="app" class="hidden">
    <div class="max-w-7xl mx-auto p-4 md:p-8">
      <header class="flex flex-col md:flex-row items-start md:items-center justify-between mb-4 gap-4">
        <h1 class="text-2xl font-semibold">Rebel Ribbon Admin</h1>
        <div class="flex flex-wrap gap-2 items-center w-full md:w-auto">
          <input id="globalSearch" type="search" placeholder="Search current tab..." class="input flex-grow md:flex-grow-0"/>
          <button id="refreshAll" class="btn flex items-center">Refresh <span id="refreshLoader" class="loader hidden ml-2"></span></button>
          <span id="who" class="text-sm text-gray-600"></span>
          <button id="logout" class="btn btn-primary">Sign out</button>
        </div>
      </header>
      <!-- Tabs -->
      <nav id="tabs" class="flex flex-wrap gap-4 border-b pb-2 mb-4"></nav>
      <!-- Toolbar -->
      <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-2 gap-4">
        <div class="flex items-center gap-2">
          <button id="addBtn" class="btn btn-primary">Add New</button>
          <button id="exportBtn" class="btn">Export CSV</button>
        </div>
        <div class="flex items-center gap-2">
          <button id="prev" class="btn disabled:opacity-50">Prev</button>
          <span id="pageInfo" class="text-sm text-gray-600"></span>
          <button id="next" class="btn disabled:opacity-50">Next</button>
        </div>
      </div>
      <!-- Table -->
      <div class="table-wrap">
        <table id="grid" class="min-w-full text-sm">
          <colgroup id="colgroup"></colgroup>
          <thead class="bg-gray-100 text-gray-700"><tr id="thead"></tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <p id="netHint" class="text-yellow-700 text-sm mt-3 hidden"></p>
    </div>
    <!-- Order Detail Panel -->
    <dialog id="orderPanel" class="w-full max-w-5xl rounded-2xl p-0">
      <form method="dialog" class="p-0">
        <div class="flex items-center justify-between p-4 border-b bg-gray-50">
          <h2 id="orderPanelTitle" class="text-lg font-semibold">Order Details</h2>
          <button class="btn btn-ghost" value="close" title="Close">✕</button>
        </div>
        <div id="orderPanelBody" class="p-4 space-y-4">
          <!-- Filled at runtime -->
        </div>
        <div class="p-4 border-t bg-gray-50 flex items-center justify-end gap-2">
          <button class="btn" value="close">Close</button>
        </div>
      </form>
    </dialog>
    <!-- Editor dialog (generic add/edit) -->
    <dialog id="editor" class="rounded-2xl p-0 w-full max-w-3xl shadow-2xl">
      <form method="dialog" class="p-0">
        <div class="p-4 border-b bg-gray-50 flex items-center justify-between">
          <h2 id="editorTitle" class="text-lg font-semibold">Edit</h2>
          <button value="close" class="btn btn-ghost">✕</button>
        </div>
        <div id="formBody" class="p-4 grid grid-cols-1 md:grid-cols-2 gap-3"></div>
        <div class="p-4 border-t bg-gray-50 flex items-center justify-end gap-2">
          <button id="deleteBtn" type="button" class="btn btn-danger hidden">Delete</button>
          <button id="saveBtn" class="btn btn-primary flex items-center">Save <span id="saveLoader" class="loader hidden ml-2"></span></button>
        </div>
      </form>
    </dialog>
  </div>
  <script>
  // Supabase
  const SUPABASE_URL = 'https://zyntkwammltmjjvgelwg.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp5bnRrd2FtbWx0bWpqdmdlbHdnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MzkxNjYsImV4cCI6MjA3ODExNTE2Nn0.eLkkGBuSRNUd7P7mJT5Be-dsvVjGBZ9pkupQq6KGT9A';
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: true } });
  // UI elements
  const signinCard = document.getElementById('signinCard');
  const app = document.getElementById('app');
  const authMsg = document.getElementById('authMsg');
  const orderPanel = document.getElementById('orderPanel');
  const orderPanelBody = document.getElementById('orderPanelBody');
  const orderPanelTitle = document.getElementById('orderPanelTitle');
  const sendLoader = document.getElementById('sendLoader');
  const refreshLoader = document.getElementById('refreshLoader');
  const saveLoader = document.getElementById('saveLoader');
  // helpers
  const onlyCompanyEmail = (email) => /@rebelribbon\.com$/i.test(email);
  const $ = (t,c,h)=>{ const e=document.createElement(t); if(c) e.className=c; if(h!==undefined) e.innerHTML=h; return e; };
  const fmt = (v)=> v==null ? '' : (typeof v==='boolean' ? (v?'Yes':'No') : String(v));
  const dateYMD=(d)=>{ if(!d) return ''; const dt=new Date(d); return dt.toISOString().slice(0,10); };
  // Magic link
  const sendBtn = document.getElementById('sendLink');
  sendBtn.addEventListener('click', async () => {
    authMsg.textContent = '';
    authMsg.className = 'text-sm';
    const email = document.getElementById('email').value.trim();
    if (!onlyCompanyEmail(email)) {
      authMsg.classList.add('text-red-600');
      authMsg.textContent = 'Use your @rebelribbon.com address.';
      return;
    }
    sendLoader.classList.remove('hidden');
    sendBtn.disabled = true;
    try {
      const redirectTo = window.location.href; // Use current URL for redirect
      const { error } = await sb.auth.signInWithOtp({ email, options: { emailRedirectTo: redirectTo } });
      if (error) throw error;
      authMsg.classList.add('text-green-700');
      authMsg.textContent = 'Magic link sent. Check your inbox.';
    } catch (e) {
      authMsg.classList.add('text-red-600');
      authMsg.textContent = e.message || 'Failed to send';
    } finally {
      sendLoader.classList.add('hidden');
      sendBtn.disabled = false;
    }
  });
  // Session bootstrap
  async function bootstrap() {
    const { data: { session }, error } = await sb.auth.getSession();
    if (error) { authMsg.textContent = error.message; return; }
    if (!session) {
      signinCard.classList.remove('hidden'); app.classList.add('hidden');
      return;
    }
    const email = session.user?.email || '';
    if (!onlyCompanyEmail(email)) {
      await sb.auth.signOut();
      authMsg.textContent = 'Restricted to @rebelribbon.com';
      return;
    }
    document.getElementById('who').textContent = email;
    signinCard.classList.add('hidden'); app.classList.remove('hidden');
    renderTabs(); loadTable(); wireRealtime();
  }
  document.getElementById('logout').addEventListener('click', async () => {
    await sb.auth.signOut();
    location.reload();
  });
  // Table configs
  const tables = {
    order_list: {
      title: 'Orders',
      table: 'orders',
      readOnly: true,
      customLoader: 'loadOrderList',
      cols: [
        { key:'created_at', label:'Submitted', type:'date', w:'18' },
        { key:'status', label:'Status', type:'text', w:'14' },
        { key:'first_name', label:'First Name', type:'text', w:'18' },
        { key:'last_name', label:'Last Name', type:'text', w:'18' },
        { key:'cookie_amount_dzns', label:'Dzns', type:'number', w:'16' }
      ]
    },
    customers: { title:'Customers', table:'customers', cols:[
      { key:'first_name', label:'First Name', type:'text', required:true, w:'14' },
      { key:'last_name', label:'Last Name', type:'text', required:true, w:'14' },
      { key:'phone', label:'Phone', type:'tel', w:'14' },
      { key:'email', label:'Email', type:'email', w:'16' },
      { key:'street_address', label:'Address', type:'text', w:'16' },
      { key:'street_address_cont', label:'Address 2', type:'text', w:'16' },
      { key:'city', label:'City', type:'text', w:'12' },
      { key:'state', label:'State', type:'text', w:'10' },
      { key:'zip', label:'Zip', type:'text', w:'10' },
      { key:'customer_id', label:'Customer ID', type:'text', w:'14' },
      { key:'referral_code_assigned', label:'Referral Code', type:'text', w:'18' },
      { key:'order_id', label:'Order ID', type:'text', w:'12' }
    ]},
    orders: { title:'Order Details', table:'orders', cols:[
      { key:'order_id', label:'Order ID', type:'text', w:'12' },
      { key:'customer_id', label:'Customer', type:'select-async', w:'20',
        asyncOptions: async () => {
          const { data } = await sb.from('customers').select('id, first_name, last_name').order('last_name').limit(1000);
          return (data||[]).map(c => ({ value:c.id, label:`${c.first_name} ${c.last_name}` }));
        }},
      { key:'pickup_delivery_date', label:'Pickup/Delivery', type:'date', w:'18' },
      { key:'event_date', label:'Event Date', type:'date', w:'14' },
      { key:'cookie_amount_dzns', label:'Dzns', type:'number', step:'0.01', w:'18' },
      { key:'flavor', label:'Flavor', type:'select-async', w:'14', asyncOptions: async () => (await sb.from('flavors').select('name').order('name')).data?.map(r=>r.name)||[] },
      { key:'dietary_option', label:'Dietary', type:'select-async', w:'16', asyncOptions: async () => (await sb.from('dietary_options').select('name').order('name')).data?.map(r=>r.name)||[] },
      { key:'design_notes', label:'Design Notes', type:'textarea', w:'20' },
      { key:'design_inspiration_photo', label:'Inspiration Photo', type:'file', w:'20' },
      { key:'gift_note', label:'Gift Note', type:'checkbox', w:'10' },
      { key:'gift_note_text', label:'Gift Note Text', type:'textarea', w:'16' },
      { key:'consultation_requested', label:'Consultation', type:'checkbox', w:'20' },
      { key:'discount_code_used', label:'Discount Code', type:'text', w:'16' },
      { key:'referral_code_used', label:'Referral Code', type:'text', w:'16' },
      { key:'status', label:'Status', type:'select', w:'14', options:['In Review','Approved','Paid','Production Complete','Fulfilled','Canceled'] }
    ]},
    discount_codes: { title:'Discounts', table:'discount_codes', cols:[
      { key:'code', label:'Code', type:'text', required:true, w:'20' },
      { key:'type', label:'Type', type:'select', options:['percent','fixed'], required:true, w:'14' },
      { key:'uses_allowed', label:'Uses Allowed', type:'number', w:'20' },
      { key:'email_allowed', label:'Email', type:'email', w:'18' },
      { key:'good_through_date', label:'Expires', type:'date', w:'18' }
    ]},
    referral_codes: { title:'Referrals', table:'referral_codes', cols:[
      { key:'code', label:'Code', type:'text', required:true, w:'20' },
      { key:'associated_customer_id', label:'Customer', type:'select-async', w:'22',
        asyncOptions: async () => {
          const { data } = await sb.from('customers').select('id, first_name, last_name').order('last_name').limit(1000);
          return (data||[]).map(c => ({ value:c.id, label:`${c.first_name} ${c.last_name}` }));
        }},
      { key:'good_through_date', label:'Expires', type:'date', w:'18' },
      { key:'referrer_discount', label:'Referrer %', type:'number', step:'0.01', w:'20' },
      { key:'referee_discount', label:'Referee %', type:'number', step:'0.01', w:'20' }
    ]},
    flavors: { title:'Flavors', table:'flavors', cols:[
      { key:'name', label:'Name', type:'text', required:true, w:'40' }
    ]},
    dietary_options: { title:'Dietary Options', table:'dietary_options', cols:[
      { key:'name', label:'Name', type:'text', required:true, w:'40' }
    ]},
    pricing: { title:'Pricing', table:'pricing', cols:[
      { key:'price_per_dozen', label:'Per Dozen', type:'number', step:'0.01', w:'20' },
      { key:'delivery_fee', label:'Delivery', type:'number', step:'0.01', w:'20' },
      { key:'consultation_fee', label:'Consultation', type:'number', step:'0.01', w:'20' },
      { key:'gift_note_fee', label:'Gift Note', type:'number', step:'0.01', w:'20' },
      { key:'rush_fee', label:'Rush', type:'number', step:'0.01', w:'20' }
    ]},
    costs: { title:'Costs', table:'costs', cols:[
      { key:'item_name', label:'Item', type:'text', required:true, w:'60' },
      { key:'amount', label:'Amount', type:'number', step:'0.01', required:true, w:'40' }
    ]},
    surveys: { title:'Surveys', table:'surveys', cols:[
      { key:'customer_id', label:'Customer', type:'select-async', w:'22',
        asyncOptions: async () => {
          const { data } = await sb.from('customers').select('id, first_name, last_name').order('last_name').limit(1000);
          return (data||[]).map(c => ({ value:c.id, label:`${c.first_name} ${c.last_name}` }));
        }},
      { key:'cookies_stars', label:'Cookies (1-5)', type:'number', min:1, max:5, w:'18' },
      { key:'service_stars', label:'Service (1-5)', type:'number', min:1, max:5, w:'18' },
      { key:'recommend', label:'Recommend', type:'checkbox', w:'22' },
      { key:'improvements', label:'Improvements', type:'textarea', w:'30' },
      { key:'website_review', label:'Website Review', type:'textarea', w:'30' }
    ]}
  };
  const tabOrder = ['order_list','customers','orders','discount_codes','referral_codes','flavors','dietary_options','pricing','costs','surveys'];
  // state
  let activeKey = tabOrder[0];
  const pageSize = 20; // Increased for efficiency
  let page = 0;
  let totalCount = 0;
  let searchTimeout;
  // build table header and widths
  function buildColGroup(conf){
    const cg = document.getElementById('colgroup'); cg.innerHTML='';
    const cols = conf.cols.slice();
    if (!conf.readOnly) cols.push({key:'__actions', w:'10'});
    const total = cols.reduce((s,c)=> s + (Number(c.w||0) || 0), 0) || 100;
    for (const c of cols){
      const col = document.createElement('col');
      const pct = (Number(c.w||0)||0) / total * 100;
      col.style.width = pct ? pct+'%' : 'auto';
      cg.appendChild(col);
    }
  }
  function buildThead(conf){
    const tr = document.getElementById('thead'); tr.innerHTML='';
    for (const c of conf.cols){
      const th = $('th','thcell nowrap text-center', c.label);
      tr.appendChild(th);
    }
    if (!conf.readOnly) tr.appendChild($('th','thcell nowrap text-center','Actions'));
  }
  // load current tab
  async function loadTable(){
    refreshLoader.classList.remove('hidden');
    const conf = tables[activeKey];
    buildColGroup(conf); buildThead(conf);
    document.getElementById('addBtn').classList.toggle('hidden', !!conf.readOnly);
    const tbody = document.getElementById('tbody'); tbody.innerHTML = '';
    if (conf.customLoader === 'loadOrderList') { await loadOrderList(); refreshLoader.classList.add('hidden'); return; }
    let query = sb.from(conf.table).select('*', { count:'exact' });
    const q = document.getElementById('globalSearch').value?.trim();
    if (q) {
      const orParts = conf.cols.map(c => `${c.key}.ilike.%${q}%`).join(',');
      if (orParts) query = query.or(orParts);
    }
    query = query.order('updated_at', { ascending:false }).range(page*pageSize, page*pageSize+pageSize-1);
    const { data, error, count } = await query;
    refreshLoader.classList.add('hidden');
    if (error) {
      tbody.appendChild($('tr','',`<td class="cell text-red-700 text-center" colspan="99">${error.message}</td>`));
      return;
    }
    totalCount = count || 0;
    renderRows(conf, data || []);
  }
  // order list loader
  async function loadOrderList(){
    const conf = tables.order_list;
    const tbody = document.getElementById('tbody'); tbody.innerHTML = '';
    let q = sb.from('orders').select('id, created_at, customer_id, cookie_amount_dzns, status', { count:'exact' })
                .order('created_at', { ascending:false })
                .range(page*pageSize, page*pageSize+pageSize-1);
    const { data: orders, error, count } = await q;
    if (error) {
      tbody.appendChild($('tr','',`<td class="cell text-red-700 text-center" colspan="99">${error.message}</td>`));
      return;
    }
    totalCount = count || 0;
    const ids = [...new Set((orders||[]).map(o => o.customer_id).filter(Boolean))];
    let map = new Map();
    if (ids.length){
      const { data: cust } = await sb.from('customers').select('id, first_name, last_name').in('id', ids);
      (cust||[]).forEach(c => map.set(c.id, c));
    }
    const rows = (orders||[]).map(o => ({
      id: o.id,
      created_at: o.created_at,
      status: o.status || 'In Review',
      first_name: map.get(o.customer_id)?.first_name || '',
      last_name: map.get(o.customer_id)?.last_name || '',
      cookie_amount_dzns: o.cookie_amount_dzns
    }));
    for (const r of rows){
      const tr = $('tr','border-b hover:bg-gray-50 cursor-pointer');
      tr.addEventListener('click', () => openOrderPanel(r.id));
      for (const c of conf.cols){
        let v = r[c.key];
        if (c.type === 'date') v = dateYMD(v);
        tr.appendChild($('td','cell nowrap text-center', fmt(v)));
      }
      tbody.appendChild(tr);
    }
    updatePager();
    document.getElementById('exportBtn').onclick = () => exportCSV(rows, conf);
  }
  // generic renderer
  function renderRows(conf, data){
    const tbody = document.getElementById('tbody'); tbody.innerHTML = '';
    for (const row of data){
      const tr = $('tr','border-b hover:bg-gray-50');
      for (const c of conf.cols){
        let val = row[c.key];
        if (c.type === 'checkbox') val = !!val;
        if (c.type === 'date') val = dateYMD(val);
        tr.appendChild($('td','cell nowrap text-center', fmt(val)));
      }
      if (!conf.readOnly){
        const td = $('td','cell text-center');
        const edit = $('button','btn','Edit');
        edit.addEventListener('click', () => openEditor(conf, row));
        td.appendChild(edit);
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
    updatePager();
    document.getElementById('exportBtn').onclick = async () => {
      const { data: allRows } = await sb.from(conf.table).select('*').order('updated_at',{ascending:false});
      exportCSV(allRows||[], conf);
    };
  }
  function exportCSV(rows, conf){
    const headers = conf.cols.map(c => c.label);
    const csvRows = [headers.join(',')];
    for (const r of rows){
      const vals = conf.cols.map(c => {
        let v = r[c.key]; if (v == null) v = '';
        const s = String(v).replaceAll('"','""');
        return `"${s}"`;
      });
      csvRows.push(vals.join(','));
    }
    const csv = csvRows.join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `${conf.title}.csv`; a.click();
    URL.revokeObjectURL(url);
  }
  function updatePager(){
    const prev = document.getElementById('prev');
    const next = document.getElementById('next');
    prev.disabled = page === 0;
    next.disabled = (page + 1) * pageSize >= totalCount;
    const shown = Math.min(totalCount, (page+1)*pageSize);
    document.getElementById('pageInfo').textContent = `${page*pageSize + 1}-${shown} of ${totalCount}`;
  }
  // Editor (generic)
  const dlg = document.getElementById('editor');
  const formBody = document.getElementById('formBody');
  async function optionEl(col, value){
    const wrap = $('label','block');
    wrap.appendChild($('span','text-sm block mb-1', col.label + (col.required ? ' *' : '')));
    let input;
    if (col.type === 'textarea'){ input = $('textarea','input w-full'); input.rows = 4; }
    else if (col.type === 'checkbox'){ input = $('input',''); input.type='checkbox'; }
    else if (col.type === 'select'){
      input = $('select','input w-full');
      input.appendChild($('option','', 'Select...'));
      (col.options||[]).forEach(o => { const opt = $('option','',o); opt.value=o; input.appendChild(opt); });
    } else if (col.type === 'select-async'){
      input = $('select','input w-full');
      input.appendChild($('option','', 'Loading...'));
      const options = await col.asyncOptions();
      input.innerHTML = '';
      input.appendChild($('option','', 'Select...'));
      for (const o of options){ const opt = $('option','', typeof o === 'string' ? o : o.label); opt.value=typeof o === 'string' ? o : o.value; input.appendChild(opt); }
    } else if (col.type === 'file'){
      input = $('input','input w-full'); input.type='file'; input.accept='image/*';
    } else {
      input = $('input','input w-full');
      input.type = col.type || 'text';
      if (col.step) input.step = col.step;
      if (col.min !== undefined) input.min = col.min;
      if (col.max !== undefined) input.max = col.max;
    }
    input.id = `fld_${col.key}`;
    if (col.required) input.required = true;
    if (col.type === 'checkbox') input.checked = !!value;
    else if (col.type === 'date') input.value = dateYMD(value);
    else if (col.type !== 'file') input.value = value ?? '';
    wrap.appendChild(input);
    return wrap;
  }
  async function openEditor(conf, row){
    document.getElementById('editorTitle').textContent = row ? `Edit ${conf.title}` : `Add ${conf.title}`;
    formBody.innerHTML = '';
    for (const c of conf.cols) formBody.appendChild(await optionEl(c, row?.[c.key]));
    const idHidden = $('input'); idHidden.type='hidden'; idHidden.id='row_id'; idHidden.value=row?.id||''; formBody.appendChild(idHidden);
    const delBtn = document.getElementById('deleteBtn');
    delBtn.classList.toggle('hidden', !row || !!conf.readOnly);
    delBtn.onclick = async () => {
      if (!row?.id || !confirm('Delete this?')) return;
      const { error } = await sb.from(conf.table).delete().eq('id', row.id);
      if (error) alert(error.message);
      else { dlg.close(); loadTable(); }
    };
    document.getElementById('saveBtn').onclick = async (e) => {
      e.preventDefault();
      saveLoader.classList.remove('hidden');
      await saveRecord(conf);
      saveLoader.classList.add('hidden');
    };
    dlg.showModal();
  }
  async function uploadOrderFile(orderId, file){
    const ext = file.name.split('.').pop().toLowerCase();
    if (!['jpg','jpeg','png','gif'].includes(ext)) throw new Error('Invalid image type');
    const path = `${orderId}/${crypto.randomUUID()}.${ext}`;
    const { error } = await sb.storage.from('order_uploads').upload(path, file);
    if (error) throw error;
    const { data: { publicUrl } } = sb.storage.from('order_uploads').getPublicUrl(path);
    return { path, publicUrl };
  }
  async function saveRecord(conf){
    const payload = {};
    for (const c of conf.cols){
      const el = document.getElementById(`fld_${c.key}`);
      if (!el) continue;
      if (c.type === 'file') continue;
      let val = (c.type === 'checkbox') ? el.checked : el.value || null;
      if (c.type === 'number' && val !== null) val = Number(val);
      payload[c.key] = val;
    }
    const id = document.getElementById('row_id').value;
    let resp;
    if (id) resp = await sb.from(conf.table).update(payload).eq('id', id).select('*').single();
    else resp = await sb.from(conf.table).insert(payload).select('*').single();
    if (resp.error) { alert(resp.error.message); return; }
    if (conf.table === 'orders'){
      const fileInput = document.getElementById('fld_design_inspiration_photo');
      if (fileInput?.files?.[0]){
        try{
          const { path } = await uploadOrderFile(resp.data.id, fileInput.files[0]);
          await sb.from('orders').update({ design_inspiration_photo: path }).eq('id', resp.data.id);
        }catch(e){ alert('Upload failed: ' + e.message); }
      }
    }
    dlg.close(); loadTable();
  }
  // Tabs, search, realtime
  function renderTabs(){
    const nav = document.getElementById('tabs'); nav.innerHTML='';
    for (const key of tabOrder){
      const conf = tables[key];
      const a = $('button','pb-1', conf.title);
      if (key === activeKey) a.classList.add('tab-active');
      a.addEventListener('click', ()=>{ activeKey = key; page = 0; renderTabs(); loadTable(); });
      nav.appendChild(a);
    }
    document.getElementById('addBtn').onclick = () => openEditor(tables[activeKey], null);
    document.getElementById('prev').onclick = () => { if (page>0) { page--; loadTable(); } };
    document.getElementById('next').onclick = () => { if ((page+1)*pageSize < totalCount) { page++; loadTable(); } };
    document.getElementById('globalSearch').oninput = () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => { page=0; loadTable(); }, 300);
    };
    document.getElementById('refreshAll').onclick = loadTable;
  }
  function wireRealtime(){
    for (const key of Object.keys(tables)){
      const tableName = key==='order_list' ? 'orders' : tables[key].table;
      sb.channel(`${key}-changes`)
        .on('postgres_changes', { event:'*', schema:'public', table: tableName },
          () => { if (key === activeKey) loadTable(); })
        .subscribe();
    }
    sb.channel('order_adjustments_changes')
      .on('postgres_changes', { event:'*', schema:'public', table: 'order_adjustments' },
        () => { if (activeKey==='order_list') loadTable(); })
      .subscribe();
  }
  // Order panel
  async function openOrderPanel(orderId){
    const [{ data: order }, { data: adjustments }, { data: pricingRows }] = await Promise.all([
      sb.from('orders').select('*').eq('id', orderId).single(),
      sb.from('order_adjustments').select('*').eq('order_id', orderId).order('created_at'),
      sb.from('pricing').select('*').order('updated_at', { ascending:false }).limit(1)
    ]);
    if (!order) return;
    const customer = order.customer_id ? (await sb.from('customers').select('*').eq('id', order.customer_id).single()).data : null;
    let photoUrl = '';
    if (order.design_inspiration_photo){
      const { data: { publicUrl } } = sb.storage.from('order_uploads').getPublicUrl(order.design_inspiration_photo);
      photoUrl = publicUrl;
    }
    const pricing = pricingRows?.[0] || { price_per_dozen: 36, delivery_fee: 0, consultation_fee: 0, gift_note_fee: 0, rush_fee: 0 };
    const base = Number(order.cookie_amount_dzns || 0) * Number(pricing.price_per_dozen || 0);
    let estTotal = base;
    if (order.consultation_requested) estTotal += Number(pricing.consultation_fee || 0);
    if (order.gift_note) estTotal += Number(pricing.gift_note_fee || 0);
    const extraFees = (adjustments||[]).filter(a => a.kind==='fee').reduce((s,a)=> s+Number(a.amount||0),0);
    const extraDiscounts = (adjustments||[]).filter(a => a.kind==='discount').reduce((s,a)=> s+Number(a.amount||0),0);
    const grand = estTotal + extraFees - extraDiscounts;
    orderPanelTitle.textContent = `Order ${order.order_id || order.id} - ${customer ? `${customer.first_name} ${customer.last_name}` : 'Unknown'}`;
    const left = $('div','space-y-4 flex-1');
    left.innerHTML = `
      <div class="card p-4 space-y-1 text-sm">
        <div><span class="font-semibold">Submitted:</span> ${dateYMD(order.created_at)}</div>
        <div><span class="font-semibold">Status:</span> ${fmt(order.status || 'In Review')}</div>
        <div><span class="font-semibold">Flavor:</span> ${fmt(order.flavor)}</div>
        <div><span class="font-semibold">Dietary:</span> ${fmt(order.dietary_option)}</div>
        <div><span class="font-semibold">Dzns:</span> ${fmt(order.cookie_amount_dzns)}</div>
        <div><span class="font-semibold">Discount:</span> ${fmt(order.discount_code_used)}</div>
        <div><span class="font-semibold">Referral:</span> ${fmt(order.referral_code_used)}</div>
        <div><span class="font-semibold">Gift Note:</span> ${order.gift_note ? 'Yes' : 'No'}</div>
        ${order.gift_note_text ? `<div><span class="font-semibold">Gift Text:</span> ${fmt(order.gift_note_text)}</div>`:''}
        ${order.design_notes ? `<div><span class="font-semibold">Design Notes:</span> ${fmt(order.design_notes)}</div>`:''}
        ${photoUrl ? `<div class="mt-3"><img src="${photoUrl}" alt="Inspiration" class="max-h-48 rounded-md border"/></div>`:''}
      </div>
      <div class="card p-4">
        <label class="block text-sm font-semibold mb-2">Update Status</label>
        <div class="flex gap-2 items-center">
          <select id="orderStatus" class="input">
            ${['In Review','Approved','Paid','Production Complete','Fulfilled','Canceled'].map(s=>`<option ${order.status===s?'selected':''}>${s}</option>`).join('')}
          </select>
          <button id="saveStatusBtn" class="btn btn-primary flex items-center">Save <span id="statusLoader" class="loader hidden ml-2"></span></button>
        </div>
      </div>
      <div class="flex flex-wrap gap-2">
        <button id="editOrderBtn" class="btn">Edit Order</button>
        <button id="addFeeBtn" class="btn">Add Fee</button>
        <button id="addDiscountBtn" class="btn">Add Discount</button>
        <button id="uploadPhotoBtn" class="btn">Upload Photo</button>
        <button id="viewInvoiceBtn" class="btn">Invoice</button>
      </div>
      <div class="card p-4 space-y-1">
        <h3 class="font-semibold mb-2">Adjustments</h3>
        <div id="adjList" class="space-y-1 text-sm">${(adjustments||[]).length ? adjustments.map(a => `<div class="flex justify-between"><span>${a.kind.charAt(0).toUpperCase() + a.kind.slice(1)}: ${a.label}</span><span>$${Number(a.amount).toFixed(2)}</span></div>`).join('') : '<div class="text-gray-500">None</div>'}</div>
      </div>
    `;
    const right = $('div','space-y-4 w-full md:w-80');
    right.innerHTML = `
      <div class="card p-4 space-y-1 text-sm">
        <h3 class="font-semibold mb-2">Estimate</h3>
        <div>Per Dozen: $${Number(pricing.price_per_dozen||0).toFixed(2)}</div>
        <div>Base: $${base.toFixed(2)}</div>
        <div>Consult: $${Number(order.consultation_requested ? pricing.consultation_fee||0 : 0).toFixed(2)}</div>
        <div>Gift Note: $${Number(order.gift_note ? pricing.gift_note_fee||0 : 0).toFixed(2)}</div>
        <div class="mt-1">Extra Fees: $${extraFees.toFixed(2)}</div>
        <div>Discounts: -$${extraDiscounts.toFixed(2)}</div>
        <hr class="my-2"/>
        <div class="text-base font-semibold">Total: $${grand.toFixed(2)}</div>
      </div>
      <div class="card p-4 space-y-1 text-sm">
        <h3 class="font-semibold mb-2">Customer</h3>
        ${customer ? `
          <div>${customer.first_name} ${customer.last_name}</div>
          <div>${customer.email || 'N/A'}</div>
          <div>${customer.phone || 'N/A'}</div>
          <div class="mt-1">${customer.street_address || ''} ${customer.street_address_cont || ''}</div>
          <div>${customer.city || ''}, ${customer.state || ''} ${customer.zip || ''}</div>
        ` : 'No customer linked'}
      </div>
    `;
    orderPanelBody.innerHTML = '';
    const container = $('div','flex flex-col md:flex-row gap-4');
    container.appendChild(left);
    container.appendChild(right);
    orderPanelBody.appendChild(container);
    // wire actions
    const statusLoader = left.querySelector('#statusLoader');
    left.querySelector('#saveStatusBtn').onclick = async () => {
      statusLoader.classList.remove('hidden');
      const newStatus = left.querySelector('#orderStatus').value;
      const { error } = await sb.from('orders').update({ status: newStatus }).eq('id', orderId);
      statusLoader.classList.add('hidden');
      if (error) alert(error.message);
      else { alert('Status updated'); loadTable(); openOrderPanel(orderId); }
    };
    left.querySelector('#editOrderBtn').onclick = () => openEditor(tables.orders, order);
    left.querySelector('#addFeeBtn').onclick = () => promptAdjustment(orderId, 'fee', openOrderPanel);
    left.querySelector('#addDiscountBtn').onclick = () => promptAdjustment(orderId, 'discount', openOrderPanel);
    left.querySelector('#uploadPhotoBtn').onclick = async () => {
      const file = await pickFile();
      if (!file) return;
      try{
        const { path } = await uploadOrderFile(orderId, file);
        await sb.from('orders').update({ design_inspiration_photo: path }).eq('id', orderId);
        openOrderPanel(orderId);
      }catch(e){ alert('Upload failed: '+e.message); }
    };
    left.querySelector('#viewInvoiceBtn').onclick = () => openInvoiceView(order, customer, pricing, adjustments||[], grand);
    orderPanel.showModal();
  }
  async function promptAdjustment(orderId, kind, refreshFn){
    const label = prompt(`Enter ${kind} label:`);
    if (!label) return;
    const amtStr = prompt(`Enter ${kind} amount:`);
    if (!amtStr) return;
    const amount = Number(amtStr);
    if (isNaN(amount) || amount <= 0) { alert('Invalid amount'); return; }
    const { error } = await sb.from('order_adjustments').insert({ order_id: orderId, kind, label, amount: kind === 'discount' ? -amount : amount });
    if (error) alert(error.message);
    else refreshFn(orderId);
  }
  function pickFile(){
    return new Promise(resolve=>{
      const input = $('input'); input.type='file'; input.accept='image/*';
      input.onchange = ()=> resolve(input.files[0] || null);
      input.click();
    });
  }
  function openInvoiceView(order, customer, pricing, adjustments, grand){
    const win = window.open('', '_blank');
    const base = Number(order.cookie_amount_dzns||0) * Number(pricing.price_per_dozen||0);
    const consult = order.consultation_requested ? Number(pricing.consultation_fee||0) : 0;
    const gift = order.gift_note ? Number(pricing.gift_note_fee||0) : 0;
    const fees = adjustments.filter(a=>a.kind==='fee').reduce((s,a)=>s+Number(a.amount||0),0);
    const discounts = Math.abs(adjustments.filter(a=>a.kind==='discount').reduce((s,a)=>s+Number(a.amount||0),0));
    const html = `
      <html><head><title>Invoice ${order.order_id || order.id}</title>
      <style>
        body{font-family:sans-serif;padding:24px;max-width:800px;margin:auto}
        .row{display:flex;justify-content:space-between;margin:.5rem 0}
        .card{border:1px solid #ddd;border-radius:8px;padding:16px;margin:16px 0}
        .h{font-weight:600}
      </style></head><body>
        <h2>Rebel Ribbon Invoice</h2>
        <div class="card">
          <div class="row h"><span>Customer</span><span>${customer ? `${customer.first_name} ${customer.last_name}` : 'N/A'}</span></div>
          <div class="row"><span>Email</span><span>${customer?.email || 'N/A'}</span></div>
          <div class="row"><span>Phone</span><span>${customer?.phone || 'N/A'}</span></div>
          <div class="row"><span>Address</span><span>${[customer?.street_address, customer?.street_address_cont, customer?.city, customer?.state, customer?.zip].filter(Boolean).join(', ')}</span></div>
        </div>
        <div class="card">
          <div class="row h"><span>Order ID</span><span>${order.order_id || order.id}</span></div>
          <div class="row"><span>Submitted</span><span>${dateYMD(order.created_at)}</span></div>
          <div class="row"><span>Status</span><span>${order.status || 'In Review'}</span></div>
        </div>
        <div class="card">
          <div class="row"><span>Base (@ $${pricing.price_per_dozen.toFixed(2)}/dz)</span><span>$${base.toFixed(2)}</span></div>
          <div class="row"><span>Consultation</span><span>$${consult.toFixed(2)}</span></div>
          <div class="row"><span>Gift Note</span><span>$${gift.toFixed(2)}</span></div>
          <div class="row"><span>Extra Fees</span><span>$${fees.toFixed(2)}</span></div>
          <div class="row"><span>Discounts</span><span>-$${discounts.toFixed(2)}</span></div>
          <hr class="my-2"/>
          <div class="row h"><span>Total</span><span>$${grand.toFixed(2)}</span></div>
        </div>
        <button onclick="window.print()" class="btn btn-primary">Print</button>
      </body></html>
    `;
    win.document.write(html);
    win.document.close();
  }
  // init
  bootstrap();
  sb.auth.onAuthStateChange((event, session) => {
    if (event === 'SIGNED_IN') bootstrap();
  });
  </script>
</body>
</html>
