<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rebel Ribbon - Order</title>
  <!-- Google Fonts: Playfair Display + Open Sans -->
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* --- RESET & BASE --- */
    html, body {
      margin: 0;
      padding: 0;
      overflow-x: hidden; /* Critical for mobile */
      width: 100%;
      min-height: 100vh;
    }
    * {
      box-sizing: border-box;
    }
    :root {
      --heading-font: 'Playfair Display', serif;
      --body-font: 'Open Sans', sans-serif;
      --pink: #FFC0CB;
      --pink-soft: #fff7fa;
      --pink-border: #fbd6e3;
      --black: #000;
      --dark-gray: #333;
      --muted: #777;
      --border-subtle: #ececec;
      --bg-subtle: #fafafa;
    }
    body {
      font-family: var(--body-font);
      color: var(--dark-gray);
      background: #fff;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }
    a {
      text-decoration: none;
      color: inherit;
    }
    img {
      max-width: 100%;
      height: auto;
      display: block;
    }

    /* --- HEADER (Reverted to Original Style) --- */
    header {
      background: #fff;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      border-bottom: 1px solid var(--border-subtle);
      z-index: 1000;
    }
    .logo img {
      height: 50px; /* Restored to 50px */
      width: auto;
      /* Removed 'content: url()' to rely on src="horizontaltrans.png" */
    }
    
    /* Desktop Nav */
    nav ul {
      list-style: none;
      display: flex;
      margin: 0;
      padding: 0;
    }
    nav li {
      margin-left: 20px; /* Restored to 20px */
    }
    nav a {
      font-size: 16px;
      color: var(--black);
      font-weight: 400; /* Restored font weight */
      transition: color 0.2s;
    }
    nav a:hover {
      color: var(--pink);
    }

    /* Mobile Nav Toggle */
    .hamburger {
      display: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--black);
      background: var(--pink);
      padding: 10px;
      border-radius: 50%;
      margin-left: auto;
      margin-right: 10px;
      width: 40px;
      height: 40px;
      align-items: center;
      justify-content: center;
      user-select: none;
    }

    /* --- MOBILE STYLES (Restored Original Media Query) --- */
    @media (max-width: 768px) {
      header { padding: 15px; }
      nav ul {
        display: none;
        flex-direction: column;
        position: absolute;
        top: 70px; 
        left: 0;
        right: 0;
        background: #fff;
        padding: 20px 0;
        text-align: center;
        z-index: 999;
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
      }
      nav li { margin: 10px 0; }
      .hamburger {
        display: inline-flex;
      }
    }

    /* --- HERO (Reverted to Original Style) --- */
    .hero {
      position: relative;
      height: 30vh; /* Restored to 30vh */
      background: url('https://via.placeholder.com/1920x1080?text=Place+Your+Order') center/cover no-repeat;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    .hero::before {
      content: "";
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255,192,203,0.5); /* Restored pink overlay */
    }
    .hero-content {
      position: relative;
      z-index: 1;
      padding: 20px;
    }
    .hero h1 {
      font-size: 36px; /* Restored to 36px */
      color: var(--black);
      font-family: var(--heading-font);
      margin-bottom: 10px; /* Restored to 10px */
    }
    .hero p {
      font-size: 18px;
      color: var(--black);
      font-family: var(--body-font);
    }


    /* --- FORM LAYOUT --- */
    .content-section {
      padding: 30px 16px 60px;
      max-width: 800px;
      margin: 0 auto;
    }
    .order-form-header {
      text-align: center;
      margin-bottom: 24px;
    }
    .order-form-title {
      font-family: var(--heading-font);
      font-size: 26px;
      margin-bottom: 8px;
    }
    .order-form-subtitle {
      font-size: 14px;
      color: var(--muted);
    }

    form#orderForm {
      background: #fff;
      padding: 20px;
      border-radius: 16px;
      border: 1px solid var(--pink-border);
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    }

    .form-section {
      background: var(--bg-subtle);
      padding: 16px;
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      margin-bottom: 16px;
    }
    .form-section-heading {
      font-family: var(--heading-font);
      font-size: 18px;
      margin-bottom: 12px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 6px;
    }

    /* Grid System */
    .two-column {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 600px) {
      .two-column {
        grid-template-columns: 1fr; /* Stack on mobile */
      }
    }

    /* Inputs */
    .form-group {
      margin-bottom: 14px;
    }
    label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .label-tag {
      font-size: 10px;
      background: var(--pink-soft);
      border: 1px solid var(--pink-border);
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 6px;
      color: var(--muted);
      vertical-align: middle;
    }
    input[type="text"],
    input[type="email"],
    input[type="tel"],
    input[type="number"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 8px; /* Slightly less rounded for better mobile keyboard support */
      font-family: var(--body-font);
      font-size: 16px; /* Prevents iOS zoom on focus */
      background: #fff;
      appearance: none; /* Removes default styling */
    }
    textarea {
      min-height: 80px;
      resize: vertical;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--pink);
      box-shadow: 0 0 0 3px var(--pink-soft);
    }

    /* Buttons */
    .primary-button {
      width: 100%;
      padding: 14px;
      background: var(--pink);
      color: #000;
      border: none;
      border-radius: 50px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }
    .primary-button:active {
      transform: scale(0.98);
    }
    .primary-button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }
    
    .secondary-button {
      margin-top: 6px;
      padding: 8px 14px;
      background: #fff;
      border: 1px solid var(--pink-border);
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
    }

    /* Messages */
    .form-message {
      text-align: center;
      font-weight: 600;
      margin-top: 10px;
      min-height: 20px;
    }
    .form-message.error { color: #d32f2f; }
    .form-message.success { color: #388e3c; }

    /* Estimate Box */
    .estimate-box {
      background: var(--pink-soft);
      padding: 15px;
      border-radius: 8px;
      border: 1px solid var(--pink-border);
      font-size: 14px;
    }
    .estimate-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
    }
    .estimate-total {
      font-weight: 700;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(0,0,0,0.1);
      font-size: 16px;
    }

    /* --- FOOTER (Based on User's 'About' Template) --- */
    footer {
      background: var(--pink);
      color: var(--black);
      padding: 40px 20px;
      margin-top: 40px;
    }
    footer .footer-content {
      max-width: 1000px;
      margin: 0 auto;
      display: flex;
      flex-wrap: wrap;
      gap: 30px;
    }
    footer .footer-section {
      flex: 1 1 200px;
    }
    footer .footer-section h3 {
      font-family: var(--heading-font);
      margin-bottom: 15px;
    }
    footer .footer-section a {
      text-decoration: underline;
    }
    
    /* Utility */
    .inline-checkbox {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
    }
    .inline-checkbox input {
      width: 20px;
      height: 20px;
      accent-color: var(--pink);
    }
    .inline-checkbox label {
      margin: 0;
      font-weight: 400;
    }
  </style>
</head>
<body>

  <!-- Header (Restored Original HTML) -->
  <header>
    <div class="logo">
      <img src="horizontaltrans.png" alt="Rebel Ribbon Logo">
    </div>
    <div class="hamburger" onclick="toggleMenu()">&#9776;</div>
    <nav>
      <ul class="nav-menu" id="navMenu">
        <li><a href="index.html">Home</a></li>
        <li><a href="about.html">About Us</a></li>
        <li><a href="ingredients.html">Ingredients</a></li>
        <li><a href="gallery.html">Gallery</a></li>
        <li><a href="contact.html">Contact</a></li>
        <li><a href="order.html">Order</a></li>
      </ul>
    </nav>
  </header>

  <!-- Hero (Restored Original HTML) -->
  <section class="hero">
    <div class="hero-content">
      <h1>Place Your Order</h1>
      <p>Indulge in our handcrafted cookies.</p>
    </div>
  </section>

  <!-- Order Form -->
  <section class="content-section">
    <div class="order-form-header">
      <h2 class="order-form-title">Custom Cookie Order</h2>
      <p class="order-form-subtitle">Fill out this form and we will confirm details and pricing.</p>
    </div>

    <form id="orderForm" novalidate>
      
      <!-- Contact Info -->
      <div class="form-section">
        <div class="form-section-heading">Your Info</div>
        <div class="two-column">
          <div class="form-group">
            <label for="first_name">First Name <span class="label-tag">Required</span></label>
            <input type="text" id="first_name" required>
          </div>
          <div class="form-group">
            <label for="last_name">Last Name <span class="label-tag">Required</span></label>
            <input type="text" id="last_name" required>
          </div>
        </div>
        <div class="two-column">
          <div class="form-group">
            <label for="email">Email <span class="label-tag">Required</span></label>
            <input type="email" id="email" required>
          </div>
          <div class="form-group">
            <label for="phone">Phone <span class="label-tag">Required</span></label>
            <input type="tel" id="phone" required>
          </div>
        </div>
      </div>

      <!-- Delivery/Pickup -->
      <div class="form-section">
        <div class="form-section-heading">Delivery or Pickup</div>
        <div class="two-column">
          <div class="form-group">
            <label for="pickup_delivery_type">Method <span class="label-tag">Required</span></label>
            <select id="pickup_delivery_type" required>
              <option value="">Select...</option>
              <option value="Pickup">Pickup</option>
              <option value="Delivery">Delivery</option>
            </select>
          </div>
          <div class="form-group">
            <label for="pickup_delivery_date">Date <span class="label-tag">Required (Min 5 days out)</span></label>
            <input type="date" id="pickup_delivery_date" required>
          </div>
        </div>

        <!-- Address Fields (Hidden by default) -->
        <div id="addressFields" style="display:none; margin-top:15px; border-top:1px dashed #ccc; padding-top:15px;">
          <div class="form-group">
            <label>Street Address <span class="label-tag">Required for Delivery</span></label>
            <input type="text" id="street_address">
          </div>
          <div class="form-group">
            <label>Apt / Suite</label>
            <input type="text" id="street_address_cont">
          </div>
          <div class="two-column">
            <div class="form-group">
              <label>City</label>
              <input type="text" id="city">
            </div>
            <div class="form-group">
              <label>State</label>
              <input type="text" id="state">
            </div>
          </div>
          <div class="form-group">
            <label>Zip Code</label>
            <input type="text" id="zip">
          </div>
        </div>
      </div>

      <!-- Order Details -->
      <div class="form-section">
        <div class="form-section-heading">Order Details</div>
        <div class="two-column">
          <div class="form-group">
            <label for="event_date">Event Date <span class="label-tag">Required (Min 5 days out)</span></label>
            <input type="date" id="event_date" required>
          </div>
          <div class="form-group">
            <label for="event_type_name">Event Type <span class="label-tag">Required</span></label>
            <input type="text" id="event_type_name" placeholder="e.g. Birthday" required>
          </div>
        </div>
        <div class="two-column">
          <div class="form-group">
            <label for="cookie_amount_dzns">Dozen Cookies <span class="label-tag">Required</span></label>
            <input type="number" id="cookie_amount_dzns" min="1" step="0.5" placeholder="1" required>
          </div>
          <div class="form-group">
            <label for="flavor">Flavor <span class="label-tag">Required</span></label>
            <select id="flavor" required>
              <option value="">Loading...</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label for="dietary_option">Dietary Option</label>
          <select id="dietary_option">
            <option value="">None</option>
          </select>
        </div>
        <div class="form-group">
          <label for="design_notes">Design Notes <span class="label-tag">Required</span></label>
          <textarea id="design_notes" required placeholder="Theme, colors, details..."></textarea>
        </div>
        <div class="form-group">
          <label for="design_inspiration_photo">Inspiration Photo</label>
          <input type="file" id="design_inspiration_photo" accept="image/*">
        </div>
      </div>

      <!-- Extras -->
      <div class="form-section">
        <div class="form-section-heading">Extras</div>
        <div class="inline-checkbox">
          <input type="checkbox" id="gift_note">
          <label for="gift_note">Add a gift note?</label>
        </div>
        <div class="form-group" id="gift_note_text_group" style="display:none;">
          <label>Gift Message</label>
          <textarea id="gift_note_text"></textarea>
        </div>
        <div class="inline-checkbox">
          <input type="checkbox" id="consultation_requested">
          <label for="consultation_requested">Request design consultation?</label>
        </div>
      </div>

      <!-- Discounts -->
      <div class="form-section">
        <div class="form-section-heading">Codes</div>
        <div class="two-column">
          <div class="form-group">
            <label>Discount Code</label>
            <input type="text" id="discount_code_used">
            <button type="button" id="applyDiscountButton" class="secondary-button">Apply Discount</button>
            <small id="discountHelp" class="code-message"></small>
          </div>
          <div class="form-group">
            <label>Referral Code</label>
            <input type="text" id="referral_code_used">
            <button type="button" id="applyReferralButton" class="secondary-button">Apply Referral</button>
            <small id="referralHelp" class="code-message"></small>
          </div>
        </div>
      </div>

      <!-- Total -->
      <div class="form-section">
        <div class="form-section-heading">Estimated Total</div>
        <div id="estimateBox" class="estimate-box">
          Enter details to see estimate.
        </div>
      </div>

      <!-- Actions -->
      <div class="form-actions">
        <button type="submit" id="submitButton" class="primary-button">Submit Request</button>
        <p id="formMessage" class="form-message"></p>
      </div>

    </form>
  </section>

  <!-- Footer (Based on User's 'About' Template) -->
  <footer>
    <div class="footer-content">
      <div class="footer-section">
        <h3>Contact Us</h3>
        <p>Email: <a href="mailto:info@rebelribbon.com">info@rebelribbon.com</a></p>
        <p>Phone: <a href="tel:2102397471">(210) 239-7471</a></p>
      </div>
      <div class="footer-section">
        <h3>Quick Links</h3>
        <p><a href="index.html">Home</a></p>
        <p><a href="about.html">About Us</a></p>
        <p><a href="ingredients.html">Ingredients</a></p>
        <p><a href="gallery.html">Gallery</a></p>
        <p><a href="contact.html">Contact</a></p>
        <p><a href="order.html">Order</a></p>
      </div>
      <div class="footer-section newsletter">
        <h3>Newsletter</h3>
        <!-- Tally Embed Code for Newsletter Signup -->
        <iframe data-tally-src="https://tally.so/embed/wokM7x?alignLeft=1&hideTitle=1&transparentBackground=1&dynamicHeight=1"
          loading="lazy" width="100%" height="200" frameborder="0" title="News Letter"></iframe>
      </div>
    </div>
  </footer>

  <!-- Supabase & Logic -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://tally.so/widgets/embed.js"></script>
  <script>
    // --- Toggle Menu Logic (Fixed for Mobile) ---
    function toggleMenu() {
      const menu = document.getElementById('navMenu');
      if (menu.style.display === 'flex') {
        menu.style.display = 'none';
      } else {
        menu.style.display = 'flex';
        menu.style.flexDirection = 'column';
      }
    }

    // --- Supabase Setup ---
    const SUPABASE_URL = "https://zyntkwammltmjjvgelwg.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp5bnRrd2FtbWx0bWpqdmdlbHdnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MzkxNjYsImV4cCI6MjA3ODExNTE2Nn0.eLkkGBuSRNUd7P7mJT5Be-dsvVjGBZ9pkupQq6KGT9A";
    const { createClient } = supabase;
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentPricing = null;
    let appliedDiscount = { type: null, amount: 0, label: "" };
    let appliedReferral = { type: null, amount: 0, label: "" };

    // --- Helpers ---
    function generateNumericId(length) {
      let result = "";
      for (let i = 0; i < length; i++) result += Math.floor(Math.random() * 10).toString();
      return result;
    }
    function formatMoney(amount) {
      return "$" + (amount || 0).toFixed(2);
    }
    function getDaysFromToday(dateStr) {
      if (!dateStr) return null;
      const d = new Date(dateStr + 'T00:00:00');
      const today = new Date();
      today.setHours(0,0,0,0);
      if (isNaN(d.getTime())) return null;
      return Math.floor((d - today) / 86400000);
    }
    
    // Helper to get date string YYYY-MM-DD relative to today
    function getRelativeDateStr(daysOffset) {
      const d = new Date();
      d.setDate(d.getDate() + daysOffset);
      return d.toISOString().split('T')[0];
    }

    // --- Data Load Functions ---
    async function loadSelectOptions() {
      const flavorSelect = document.getElementById("flavor");
      const dietarySelect = document.getElementById("dietary_option");

      // Load Flavors
      const { data: flavors } = await sb.from("flavors").select("name").order("name");
      flavorSelect.innerHTML = '<option value="">Select Flavor</option>';
      if (flavors) flavors.forEach(f => flavorSelect.innerHTML += `<option value="${f.name}">${f.name}</option>`);

      // Load Dietary
      const { data: diets } = await sb.from("dietary_options").select("name").order("name");
      dietarySelect.innerHTML = '<option value="">None</option>';
      if (diets) diets.forEach(d => dietarySelect.innerHTML += `<option value="${d.name}">${d.name}</option>`);
    }

    async function loadPricing() {
      const box = document.getElementById("estimateBox");
      const { data: priceData } = await sb.from("pricing").select("*").order("created_at", {ascending:false}).limit(1).maybeSingle();
      
      if (priceData) {
        currentPricing = {
          price_per_dozen: Number(priceData.price_per_dozen),
          delivery_fee: Number(priceData.delivery_fee),
          consultation_fee: Number(priceData.consultation_fee),
          gift_note_fee: Number(priceData.gift_note_fee),
          rush_fee: Number(priceData.rush_fee)
        };
        updateEstimate();
      } else {
        box.innerHTML = "<div class='estimate-note'>Pricing is not available right now. We will send your quote manually.</div>";
      }
    }

    // --- UI/Estimate Logic ---
    function updateAddressVisibility() {
      const typeSelect = document.getElementById("pickup_delivery_type");
      const addressFields = document.getElementById("addressFields");
      if (!typeSelect || !addressFields) return;

      if (typeSelect.value === "Delivery") {
        addressFields.style.display = "block";
      } else {
        addressFields.style.display = "none";
        // Clear values when switching to Pickup (important for submission data)
        ["street_address","street_address_cont","city","state","zip"].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.value = "";
        });
      }
    }
    
    function updateEstimate() {
      const box = document.getElementById("estimateBox");
      if (!box || !currentPricing) {
        if(box) box.innerHTML = "<div class='estimate-note'>Pricing is not available right now.</div>";
        return;
      }

      const qtyInput = document.getElementById("cookie_amount_dzns");
      const pickupType = document.getElementById("pickup_delivery_type");
      const pickupDateInput = document.getElementById("pickup_delivery_date");
      const giftNoteCheckbox = document.getElementById("gift_note");
      const consultCheckbox = document.getElementById("consultation_requested");

      const dzns = qtyInput && qtyInput.value ? parseFloat(qtyInput.value) : 0;

      const pricePerDozen = parseFloat(currentPricing.price_per_dozen || 0);
      const deliveryFee = parseFloat(currentPricing.delivery_fee || 0);
      const consultFee = parseFloat(currentPricing.consultation_fee || 0);
      const giftNoteFee = parseFloat(currentPricing.gift_note_fee || 0);
      const rushFee = parseFloat(currentPricing.rush_fee || 0);

      const baseSubtotal = dzns > 0 ? dzns * pricePerDozen : 0;
      
      // Calculate conditional charges
      const deliveryCharge = pickupType && pickupType.value === "Delivery" ? deliveryFee : 0;
      const consultCharge = consultCheckbox && consultCheckbox.checked ? consultFee : 0;
      const giftCharge = giftNoteCheckbox && giftNoteCheckbox.checked ? giftNoteFee : 0;

      // Rush fee calculation
      let rushCharge = 0;
      if (pickupDateInput && pickupDateInput.value && rushFee > 0) {
        const daysOut = getDaysFromToday(pickupDateInput.value);
        if (daysOut !== null && daysOut >= 0 && daysOut <= 10) {
          rushCharge = rushFee;
        }
      }

      const totalBeforeDiscount = baseSubtotal + deliveryCharge + consultCharge + giftCharge + rushCharge;

      // DISCOUNTS (Ensure these are correctly calculated and subtracted from the total)
      let discountTotal = 0;
      let discountLines = "";
      
      // --- START Discount & Referral Calculation Logic ---
      // Note: We use totalBeforeDiscount as the base for percentage calculation, 
      // which includes all fees.
      if (appliedDiscount && appliedDiscount.amount > 0) {
        let discountAmount = 0;
        if (appliedDiscount.type === "percent") {
          discountAmount = totalBeforeDiscount * (appliedDiscount.amount / 100);
        } else {
          discountAmount = appliedDiscount.amount;
        }
        discountTotal += discountAmount;
        discountLines += "<div class='estimate-row'><span>" +
          (appliedDiscount.label || "Discount") +
          "</span><span>-" + formatMoney(discountAmount) + "</span></div>";
      }

      if (appliedReferral && appliedReferral.amount > 0) {
        let referralAmount = 0;
        if (appliedReferral.type === "percent") {
          referralAmount = totalBeforeDiscount * (appliedReferral.amount / 100);
        } else {
          referralAmount = appliedReferral.amount;
        }
        discountTotal += referralAmount;
        discountLines += "<div class='estimate-row'><span>" +
          (appliedReferral.label || "Referral discount") +
          "</span><span>-" + formatMoney(referralAmount) + "</span></div>";
      }
      
      if (discountTotal > totalBeforeDiscount) {
        discountTotal = totalBeforeDiscount;
      }
      // --- END Discount & Referral Calculation Logic ---

      const totalAfterDiscount = totalBeforeDiscount - discountTotal;

      let html = "";
      html += "<div class='estimate-row'><span>Cookies (" +
        (dzns || 0) + " dozen @ " + formatMoney(pricePerDozen) + ")</span><span>" +
        formatMoney(baseSubtotal) + "</span></div>";
      
      // --- CONDITIONAL FEES DISPLAY ---
      // Only show Delivery if deliveryCharge > 0
      if (deliveryCharge > 0) {
        html += "<div class='estimate-row'><span>Delivery Fee</span><span>" +
          formatMoney(deliveryCharge) + "</span></div>";
      }
      // Only show Consultation if consultCharge > 0
      if (consultCharge > 0) {
        html += "<div class='estimate-row'><span>Design Consultation Fee</span><span>" +
          formatMoney(consultCharge) + "</span></div>";
      }
      // Only show Gift Note if giftCharge > 0
      if (giftCharge > 0) {
        html += "<div class='estimate-row'><span>Gift Note Fee</span><span>" +
          formatMoney(giftCharge) + "</span></div>";
      }
      // Only show Rush Fee if rushCharge > 0
      if (rushCharge > 0) {
        html += "<div class='estimate-row'><span>Rush Fee (0-10 days)</span><span>" +
          formatMoney(rushCharge) + "</span></div>";
      }
      
      if (discountLines) {
        html += discountLines;
      }

      html += "<div class='estimate-total'><span>Estimated Total: </span><span>" +
        formatMoney(totalAfterDiscount) + "</span></div>";
      html += "<div class='estimate-note'>This is an estimate based on current menu pricing. Final pricing, discounts, and tax are confirmed manually.</div>";
      
      box.innerHTML = html;
    }

    // --- Discount/Referral Functions ---
    async function applyDiscount() {
      const discountHelp = document.getElementById("discountHelp");
      const discountCode = document.getElementById("discount_code_used").value.trim();
      const email = document.getElementById("email").value.trim();

      appliedDiscount = { type: null, amount: 0, label: "" };
      if (discountHelp) discountHelp.textContent = "";

      if (!discountCode) {
        if (discountHelp) discountHelp.textContent = "Enter a discount code to apply.";
        updateEstimate();
        return;
      }

      const today = new Date().toISOString().slice(0, 10);
      let messages = [];

      try {
        const { data: disc, error: discError } = await sb
          .from("discount_codes")
          .select("*")
          .eq("code", discountCode)
          .maybeSingle();

        if (discError) {
          messages.push("Error checking discount code. Please try again.");
        } else if (!disc) {
          messages.push("Discount code not found.");
        } else {
          let valid = true;

          if (disc.good_through_date && disc.good_through_date < today) {
            valid = false;
            messages.push("Discount code is expired.");
          }
          if (disc.email_allowed && email &&
              disc.email_allowed.toLowerCase() !== email.toLowerCase()) {
            valid = false;
            messages.push("Discount code is not valid for this email.");
          }
          if (disc.uses_allowed && disc.uses_allowed > 0 &&
              disc.uses_count >= disc.uses_allowed) {
            valid = false;
            messages.push("Discount code has already been used up.");
          }

          if (valid) {
            const typeRaw = (disc.type || "").toLowerCase();
            const amountNum = Number(disc.amount || 0);
            if (amountNum > 0) {
              if (typeRaw === "percent" || typeRaw === "percentage") {
                appliedDiscount = {
                  type: "percent",
                  amount: amountNum,
                  label: "Discount (" + discountCode + " - " + amountNum + "%)"
                };
              } else {
                appliedDiscount = {
                  type: "amount",
                  amount: amountNum,
                  label: "Discount (" + discountCode + ")"
                };
              }
              messages.push("Discount code applied.");
            } else {
              messages.push("Discount code has no discount amount configured.");
            }
          }
        }
      } catch (err) {
        console.error("Error validating discount code", err);
        messages.push("Unexpected error while validating discount code. Please try again.");
      }

      if (discountHelp) {
        discountHelp.textContent = messages.join(" ");
      }
      updateEstimate();
    }

    async function applyReferral() {
      const referralHelp = document.getElementById("referralHelp");
      const referralCode = document.getElementById("referral_code_used").value.trim();

      appliedReferral = { type: null, amount: 0, label: "" };
      if (referralHelp) referralHelp.textContent = "";

      if (!referralCode) {
        if (referralHelp) referralHelp.textContent = "Enter a referral code to apply.";
        updateEstimate();
        return;
      }

      const today = new Date().toISOString().slice(0, 10);
      let messages = [];

      try {
        const { data: ref, error: refError } = await sb
          .from("referral_codes")
          .select("*")
          .eq("code", referralCode)
          .maybeSingle();

        if (refError) {
          messages.push("Error checking referral code. Please try again.");
        } else if (!ref) {
          messages.push("Referral code not found.");
        } else {
          let validRef = true;

          if (ref.good_through_date && ref.good_through_date < today) {
            validRef = false;
            messages.push("Referral code is expired.");
          }

          if (validRef) {
            const refPercent = Number(ref.referee_discount || 0);
            if (refPercent > 0) {
              appliedReferral = {
                type: "percent",
                amount: refPercent,
                label: "Referral (" + referralCode + " - " + refPercent + "%)"
              };
              messages.push("Referral code applied.");
            } else {
              messages.push("Referral code has no discount configured.");
            }
          }
        }
      } catch (err) {
        console.error("Error validating referral code", err);
        messages.push("Unexpected error while validating referral code. Please try again.");
      }

      if (referralHelp) {
        referralHelp.textContent = messages.join(" ");
      }
      updateEstimate();
    }

    async function handleOrderSubmit(event) {
      event.preventDefault();
      const submitButton = document.getElementById("submitButton");
      const messageEl = document.getElementById("formMessage");

      messageEl.textContent = "";
      messageEl.className = "form-message";

      // Always required fields
      const requiredIds = [
        "first_name",
        "last_name",
        "email",
        "phone",
        "pickup_delivery_type",
        "pickup_delivery_date",
        "event_date",
        "event_type_name",
        "cookie_amount_dzns",
        "flavor",
        "design_notes"
      ];

      let missing = [];
      requiredIds.forEach(id => {
        const el = document.getElementById(id);
        if (el && !el.value.trim()) {
          missing.push(id);
        }
      });

      const pickupTypeVal = document.getElementById("pickup_delivery_type").value;

      // Address required only if Delivery is selected
      if (pickupTypeVal === "Delivery") {
        ["street_address", "city", "state", "zip"].forEach(id => {
          const el = document.getElementById(id);
          if (el && !el.value.trim()) {
            missing.push(id);
          }
        });
      }

      // Gift note text required if gift note is checked
      const giftNoteCheckbox = document.getElementById("gift_note");
      const giftNoteTextEl = document.getElementById("gift_note_text");

      if (giftNoteCheckbox && giftNoteCheckbox.checked) {
        if (!giftNoteTextEl.value.trim()) {
          missing.push("gift_note_text");
        }
      }

      // Inspiration photo, discount_code_used, referral_code_used are intentionally not required
      if (missing.length > 0) {
        messageEl.textContent = "Please fill in all required fields.";
        messageEl.classList.add("error");
        return;
      }

      // Extra date rules
      const pickup_delivery_date = document.getElementById("pickup_delivery_date").value;
      const event_date_value = document.getElementById("event_date").value;

      // Pickup date must be at least 5 days from today
      if (pickup_delivery_date) {
        const pickupDateObj = new Date(pickup_delivery_date);
        const minPickup = new Date();
        minPickup.setHours(0, 0, 0, 0);
        minPickup.setDate(minPickup.getDate() + 4);

        if (isNaN(pickupDateObj.getTime()) || pickupDateObj < minPickup) {
          messageEl.textContent = "Pickup or delivery date must be at least 5 days from today.";
          messageEl.classList.add("error");
          return;
        }
      } else {
        messageEl.textContent = "Please select a pickup or delivery date.";
        messageEl.classList.add("error");
        return;
      }

      // Event date rules - at least 5 days from today and not before pickup or delivery date
      if (event_date_value) {
        const eventDateObj = new Date(event_date_value);
        const pickupDateObj = new Date(pickup_delivery_date);
        const minEvent = new Date();
        minEvent.setHours(0, 0, 0, 0);
        minEvent.setDate(minEvent.getDate() + 4);

        if (isNaN(eventDateObj.getTime()) || eventDateObj < minEvent) {
          messageEl.textContent = "Event date must be at least 5 days from today.";
          messageEl.classList.add("error");
          return;
        }
        if (!isNaN(eventDateObj.getTime()) && !isNaN(pickupDateObj.getTime()) && eventDateObj < pickupDateObj) {
          messageEl.textContent = "Event date cannot be before the pickup or delivery date.";
          messageEl.classList.add("error");
          return;
        }
      } else {
        messageEl.textContent = "Please select an event date.";
        messageEl.classList.add("error");
        return;
      }

      submitButton.disabled = true;
      submitButton.textContent = "Submitting...";

      try {
        // Customer values
        const first_name = document.getElementById("first_name").value.trim();
        const last_name = document.getElementById("last_name").value.trim();
        const email = document.getElementById("email").value.trim();
        const phone = document.getElementById("phone").value.trim();
        const street_address = document.getElementById("street_address").value.trim();
        const street_address_cont = document.getElementById("street_address_cont").value.trim();
        const city = document.getElementById("city").value.trim();
        const state = document.getElementById("state").value.trim();
        const zip = document.getElementById("zip").value.trim();

        // Generate IDs
        const generatedCustomerId = generateNumericId(7);
        const generatedOrderId = generateNumericId(9);

        // Order values
        const pickup_delivery_type = pickupTypeVal;
        const event_date = event_date_value || null;
        const event_type_name = document.getElementById("event_type_name").value.trim();
        const cookie_amount_dzns = parseFloat(document.getElementById("cookie_amount_dzns").value);
        const flavor = document.getElementById("flavor").value;
        const dietary_option = document.getElementById("dietary_option").value || null;
        const design_notes = document.getElementById("design_notes").value.trim();
        const gift_note = giftNoteCheckbox.checked;
        const gift_note_text_raw = giftNoteTextEl.value.trim();
        const gift_note_text = gift_note ? (gift_note_text_raw || null) : null;
        const consultation_requested = document.getElementById("consultation_requested").checked;
        const discount_code_used = document.getElementById("discount_code_used").value.trim() || null;
        const referral_code_used = document.getElementById("referral_code_used").value.trim() || null;

        if (isNaN(cookie_amount_dzns) || cookie_amount_dzns <= 0) {
          throw new Error("Please enter a valid number of dozens.");
        }

        // File upload handling for inspiration photo (optional)
        const inspirationFileInput = document.getElementById("design_inspiration_photo");
        let design_inspiration_photo = null;

        if (inspirationFileInput && inspirationFileInput.files.length > 0) {
          const file = inspirationFileInput.files[0];
          const fileExt = file.name.split(".").pop();
          const filePath = "inspirations/" + crypto.randomUUID() + "." + fileExt;

          const { data: uploadData, error: uploadError } = await sb
            .storage
            .from("order_uploads")
            .upload(filePath, file);

          if (uploadError) {
            console.error(uploadError);
            throw new Error("Unable to upload inspiration photo.");
          }

          const { data: urlData } = sb
            .storage
            .from("order_uploads")
            .getPublicUrl(filePath);

          design_inspiration_photo = urlData.publicUrl;
        }

        // Find or create customer by email
        let customerId = null;
        const { data: existingCustomers, error: customerLookupError } = await sb
          .from("customers")
          .select("id")
          .eq("email", email);

        if (customerLookupError) {
          console.error("Customer lookup error", customerLookupError);
          throw new Error("There was a problem looking up your customer record.");
        }

        if (existingCustomers && existingCustomers.length > 0) {
          customerId = existingCustomers[0].id;
        } else {
          const { data: newCustomer, error: newCustomerError } = await sb
            .from("customers")
            .insert([
              {
                first_name,
                last_name,
                email,
                phone,
                street_address,
                street_address_cont,
                city,
                state,
                zip,
                customer_id: generatedCustomerId
              }
            ])
            .select("id")
            .single();

          if (newCustomerError) {
            console.error("Customer insert error", newCustomerError);
            throw new Error("There was a problem creating your customer record.");
          }
          customerId = newCustomer.id;
        }

        // Create and attach referral code for this customer
        try {
          const referralCode = await generateUniqueReferralCode(first_name, last_name);
          const { error: referralInsertError } = await sb
            .from("referral_codes")
            .insert([
              {
                code: referralCode,
                associated_customer_id: customerId
              }
            ]);

          if (referralInsertError) {
            console.error("Referral insert error", referralInsertError);
          }
        } catch (refErr) {
          console.error("Unexpected referral creation error", refErr);
        }

        // Insert order
        const { data: newOrder, error: orderError } = await sb
          .from("orders")
          .insert([
            {
              order_id: generatedOrderId,
              customer_id: customerId,
              pickup_delivery_date,
              event_date,
              cookie_amount_dzns,
              flavor,
              dietary_option,
              design_notes,
              design_inspiration_photo,
              gift_note: giftNoteCheckbox.checked,
              gift_note_text: giftNoteCheckbox.checked ? (giftNoteTextEl.value.trim() || null) : null,
              consultation_requested,
              discount_code_used,
              referral_code_used,
              event_type_name,
              pickup_delivery_type,
              status: "In Review"
            }
          ])
          .select("id, order_id")
          .maybeSingle();

        if (orderError) {
          console.error("Order insert error full", JSON.stringify(orderError, null, 2));
          throw new Error("There was a problem saving your order. Please try again or contact us directly.");
        }

        // Optional rush fee adjustment entry
        if (newOrder && newOrder.id && currentPricing && currentPricing.rush_fee > 0) {
          const daysOut = getDaysFromToday(pickup_delivery_date);
          if (daysOut !== null && daysOut >= 0 && daysOut <= 10) {
            const adj = {
              order_id: newOrder.id,
              label: "Rush fee",
              amount: currentPricing.rush_fee,
              kind: "fee"
            };
            try {
              await sb.from("order_adjustments").insert([adj]);
            } catch (adjErr) {
              console.error("Order adjustment insert error", adjErr);
            }
          }
        }

        messageEl.textContent = "Thank you. Your request has been submitted. We will contact you to confirm details.";
        messageEl.classList.add("success");
        document.getElementById("orderForm").reset();
        document.getElementById("gift_note_text_group").style.display = "none";
        appliedDiscount = { type: null, amount: 0, label: "" };
        appliedReferral = { type: null, amount: 0, label: "" };
        updateAddressVisibility();
        updateEstimate();

        setTimeout(() => {
          window.location.href = "https://rebelribbon.com/thanks.html";
        }, 2000);
      } catch (err) {
        console.error(err);
        messageEl.textContent = err.message || "Something went wrong. Please try again or contact us directly.";
        messageEl.classList.add("error");
      } finally {
        submitButton.disabled = false;
        submitButton.textContent = "Submit Request";
      }
    }

    document.addEventListener("DOMContentLoaded", function() {
      loadSelectOptions();
      loadPricing();

      const pickupDateInput = document.getElementById("pickup_delivery_date");
      const eventDateInput = document.getElementById("event_date");

      // Base min date (today + 5 days)
      const baseMin = new Date();
      baseMin.setHours(0, 0, 0, 0);
      baseMin.setDate(baseMin.getDate() + 5);
      const yyyy = baseMin.getFullYear();
      const mm = String(baseMin.getMonth() + 1).padStart(2, "0");
      const dd = String(baseMin.getDate()).padStart(2, "0");
      const baseMinStr = yyyy + "-" + mm + "-" + dd;

      if (pickupDateInput) {
        pickupDateInput.min = baseMinStr;
        pickupDateInput.addEventListener("change", function() {
          // Adjust event date min to be max(baseMin, pickup date)
          if (eventDateInput && pickupDateInput.value) {
            const pickupStr = pickupDateInput.value;
            const pickupDateObj = new Date(pickupStr);
            pickupDateObj.setHours(0, 0, 0, 0);

            const maxMinDate = pickupDateObj.getTime() > baseMin.getTime() ? pickupDateObj : baseMin;
            const yyyy2 = maxMinDate.getFullYear();
            const mm2 = String(maxMinDate.getMonth() + 1).padStart(2, "0");
            const dd2 = String(maxMinDate.getDate()).padStart(2, "0");
            eventDateInput.min = yyyy2 + "-" + mm2 + "-" + dd2;
          }
          updateEstimate();
        });
        pickupDateInput.addEventListener("input", updateEstimate);
      }

      if (eventDateInput) {
        // Initial min for event date at load
        eventDateInput.min = baseMinStr;
      }

      const giftNoteCheckbox = document.getElementById("gift_note");
      const giftNoteTextGroup = document.getElementById("gift_note_text_group");
      if (giftNoteCheckbox) {
        giftNoteCheckbox.addEventListener("change", function() {
          giftNoteTextGroup.style.display = this.checked ? "block" : "none";
          updateEstimate();
        });
      }

      const pickupTypeSelect = document.getElementById("pickup_delivery_type");
      if (pickupTypeSelect) {
        pickupTypeSelect.addEventListener("change", function() {
          updateAddressVisibility();
          updateEstimate();
        });
        updateAddressVisibility();
      }

      const qtyInput = document.getElementById("cookie_amount_dzns");
      if (qtyInput) {
        qtyInput.addEventListener("input", updateEstimate);
        qtyInput.addEventListener("change", updateEstimate);
      }

      const consultCheckbox = document.getElementById("consultation_requested");
      if (consultCheckbox) {
        consultCheckbox.addEventListener("change", updateEstimate);
      }

      const applyDiscountButton = document.getElementById("applyDiscountButton");
      if (applyDiscountButton) {
        applyDiscountButton.addEventListener("click", applyDiscount);
      }

      const applyReferralButton = document.getElementById("applyReferralButton");
      if (applyReferralButton) {
        applyReferralButton.addEventListener("click", applyReferral);
      }

      const form = document.getElementById("orderForm");
      if (form) {
        form.addEventListener("submit", handleOrderSubmit);
      }

      updateEstimate();
    });

    function toggleMenu() {
      var menu = document.getElementById('navMenu');
      var currentDisplay = window.getComputedStyle(menu).display;
      if (currentDisplay === 'none') {
        menu.style.display = 'flex';
        menu.style.flexDirection = 'column';
      } else {
        menu.style.display = 'none';
      }
    }
  </script>
</body>
</html>
