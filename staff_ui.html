<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Rebel Ribbon Staff UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { margin: 0; display: flex; min-height: 100vh; }
        #app-wrapper { display: flex; width: 100%; }
        #signinCard {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000;
            background-color: #f9fafb;
        }
        #app-wrapper.hidden { display: none; }
        #sidebar { width: 200px; background-color: #1f2937; color: white; flex-shrink: 0; padding: 1rem 0; }
        .nav-item { display: block; padding: 0.75rem 1rem; cursor: pointer; transition: background-color 0.15s; }
        .nav-item:hover { background-color: #374151; }
        .nav-active { background-color: #374151; font-weight: 600; border-left: 4px solid #3b82f6; padding-left: calc(1rem - 4px); }
        .submenu-item { padding: 0.5rem 1rem 0.5rem 2rem; font-size: 0.875rem; }
        #content { flex-grow: 1; padding: 2rem; }
        .filter-tab { padding: 0.5rem 1rem; border-radius: 9999px; cursor: pointer; font-weight: 500; transition: background-color 0.15s; }
        .filter-tab:hover { background-color: #e5e7eb; }
        .filter-active { background-color: #1d4ed8; color: white; }
        .table-wrap { overflow: auto; border-radius: 0.75rem; border: 1px solid #e5e7eb; background: #fff; }
        table { border-collapse: separate; border-spacing: 0; }
        .cell { padding: 0.75rem; }
        .thcell { padding: 0.75rem; font-weight: 600; }
        .nowrap { white-space: nowrap; }
        dialog::backdrop { background: rgba(0, 0, 0, 0.25); }
        .drawer { width: 100%; max-width: 1080px; }
        .status-badge { display: inline-block; padding: 0.25rem 0.6rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .status-in-review { background-color: #fef3c7; color: #b45309; }
        .status-approved { background-color: #bfdbfe; color: #1e40af; }
        .status-paid { background-color: #d1fae5; color: #065f46; }
        .status-production-complete { background-color: #fee2e2; color: #991b1b; }
        .status-fulfilled { background-color: #e0f2f1; color: #0f766e; }
        .status-canceled { background-color: #f3f4f6; color: #6b7280; }
        .urgent-date { color: #dc2626; font-weight: 700; }
        .info-card { background-color: #fff; border-radius: 0.75rem; border: 1px solid #e5e7eb; padding: 1rem; }
        .btn-primary { background-color: #3b82f6; color: white; transition: background-color 0.15s; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-secondary { background-color: white; color: #374151; border: 1px solid #d1d5db; transition: background-color 0.15s; }
        .btn-secondary:hover { background-color: #f3f4f6; }
        .btn-success { background-color: #10b981; color: white; transition: background-color 0.15s; }
        .btn-success:hover { background-color: #059669; }
        .btn-icon { padding: 0.5rem; border-radius: 0.5rem; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    <div id="signinCard" class="flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white rounded-2xl shadow p-6">
            <h1 class="text-2xl font-semibold mb-2">Rebel Ribbon Staff Sign in</h1>
            <p class="text-sm text-gray-600 mb-4">Use your @rebelribbon.com email and password.</p>
            <label class="block text-sm mb-2">Email</label>
            <input id="email" type="email" placeholder="you@rebelribbon.com" class="w-full px-3 py-2 rounded-lg border mb-4"/>
            <label class="block text-sm mb-2">Password</label>
            <input id="password" type="password" placeholder="Password" class="w-full px-3 py-2 rounded-lg border mb-4"/>
            <button id="signInButton" class="w-full px-4 py-2 rounded-lg btn-primary">Sign In</button>
            <p id="authMsg" class="text-sm text-red-600 mt-3"></p>
            <p class="text-xs text-gray-500 mt-3">If the button does nothing, check Supabase keys and ensure Email/Password provider is enabled.</p>
        </div>
    </div>
    <div id="app-wrapper" class="hidden">
        <nav id="sidebar">
            <h1 class="text-xl font-semibold px-4 mb-6 text-white/90">Rebel Ribbon</h1>
            <div id="main-nav">
                <button id="nav_orders" class="nav-item nav-active" data-key="order_list">Orders</button>
                <button id="nav_surveys" class="nav-item" data-key="surveys">Surveys</button>
            </div>
            <div class="mt-8">
                <h3 class="text-xs uppercase font-medium text-gray-400 px-4 mb-2">Admin / Settings</h3>
                <button id="nav_customers" class="nav-item submenu-item" data-key="customers">Customers</button>
                <button id="nav_discount_codes" class="nav-item submenu-item" data-key="discount_codes">Discount Codes</button>
                <button id="nav_referral_codes" class="nav-item submenu-item" data-key="referral_codes">Referral Codes</button>
                <button id="nav_flavors" class="nav-item submenu-item" data-key="flavors">Flavors & Options</button>
                <button id="nav_pricing" class="nav-item submenu-item" data-key="pricing">Pricing & Fees</button>
                <button id="nav_costs" class="nav-item submenu-item" data-key="costs">Costs</button>
            </div>
            <div class="mt-8 pt-4 border-t border-gray-700 px-4 text-xs text-gray-400">
                <span id="who" class="block truncate mb-2"></span>
                <button id="logout" class="px-3 py-1 text-xs rounded bg-gray-600 text-white hover:bg-gray-500">Sign out</button>
            </div>
        </nav>
        <main id="content" class="max-w-7xl">
            <!-- header, filters, pager, table same as before -->
            <header class="flex items-center justify-between mb-6">
                <h2 id="pageTitle" class="text-3xl font-bold">Orders</h2>
                <div class="flex gap-4 items-center">
                    <input id="globalSearch" type="search" placeholder="Search customer, ID, date" class="px-4 py-2 rounded-lg border w-72 shadow-sm"/>
                    <button id="refreshAll" class="px-3 py-2 rounded-lg btn-secondary shadow-sm">Refresh</button>
                </div>
            </header>
            <div id="orderFilters" class="flex flex-wrap gap-3 mb-4">
                <button class="filter-tab filter-active" data-filter="All">All Orders</button>
                <button class="filter-tab" data-filter="In Review">‚≠ê New Orders</button>
                <button class="filter-tab" data-filter="Approved">üí∏ Needs Payment</button>
                <button class="filter-tab" data-filter="Paid">üè≠ In Production</button>
                <button class="filter-tab" data-filter="Production Complete">üöö Ready for Fulfillment</button>
                <button class="filter-tab" data-filter="Fulfilled">‚úÖ Completed</button>
            </div>
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <button id="addBtn" class="px-3 py-2 rounded-lg btn-primary shadow-md">Add New</button>
                    <button id="exportBtn" class="px-3 py-2 rounded-lg btn-secondary shadow-sm">Export CSV</button>
                </div>
                <div class="flex items-center gap-2">
                    <button id="prev" class="px-3 py-2 rounded-lg btn-secondary disabled:opacity-50">Prev</button>
                    <span id="pageInfo" class="text-sm text-gray-600"></span>
                    <button id="next" class="px-3 py-2 rounded-lg btn-secondary disabled:opacity-50">Next</button>
                </div>
            </div>
            <div class="table-wrap">
                <table id="grid" class="min-w-full text-sm table-fixed">
                    <colgroup id="colgroup"></colgroup>
                    <thead class="bg-gray-100 text-gray-700"><tr id="thead"></tr></thead>
                    <tbody id="tbody"></tbody>
                </table>
            </div>
            <p id="netHint" class="text-yellow-700 text-sm mt-3 hidden"></p>
        </main>
    </div>

    <!-- editor dialog same -->

    <dialog id="orderDrawer" class="rounded-2xl p-0 shadow-2xl drawer">
        <div class="p-0">
            <div class="sticky top-0 z-10 p-4 border-b bg-white flex items-center justify-between shadow-sm">
                <div class="flex items-center gap-4">
                    <button value="close" id="backToOrders" class="text-xl p-2 rounded hover:bg-gray-100 btn-icon">‚Üê Back to Orders</button>
                    <h2 id="drawerTitle" class="text-xl font-semibold">Order #XXXX</h2>
                </div>
                <div class="flex items-center gap-3">
                    <div class="flex items-center gap-2 p-1 border rounded-lg bg-gray-50">
                        <label class="font-medium text-sm">Status:</label>
                        <select id="statusSelect" class="px-3 py-2 rounded-lg border shadow-sm">
                            <option value="In Review">In Review</option>
                            <option value="Approved">Approved</option>
                            <option value="Paid">Paid</option>
                            <option value="Production Complete">Production Complete</option>
                            <option value="Fulfilled">Fulfilled</option>
                            <option value="Canceled">Canceled</option>
                        </select>
                        <button id="saveStatus" type="button" class="px-4 py-2 rounded-lg btn-success">Save Status</button>
                    </div>
                    <button id="editFields" type="button" class="px-4 py-2 rounded-lg btn-secondary font-medium">Edit All Fields</button>
                    <button id="viewInvoice" type="button" class="px-4 py-2 rounded-lg btn-primary shadow-md font-medium">Generate Invoice / Save PDF</button>
                </div>
            </div>
            <div class="p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 space-y-6">
                    <div class="info-card">
                        <h3 class="text-lg font-semibold mb-3">üé® Design & Details</h3>
                        <div class="grid grid-cols-2 gap-4 text-sm mb-4">
                            <div><span class="font-medium">Flavor:</span> <span id="ov_flavor"></span></div>
                            <div><span class="font-medium">Dietary Option:</span> <span id="ov_dietary"></span></div>
                            <div><span class="font-medium">Cookie Dzns:</span> <span id="ov_dzns"></span></div>
                        </div>
                        <label class="block text-sm font-medium mb-1">Design Notes (Primary Request)</label>
                        <p class="p-3 border rounded-lg bg-gray-50 text-base" id="ov_notes"></p>
                    </div>
                    <!-- inspiration & gift same -->
                    <div class="info-card">
                        <h3 class="text-lg font-semibold mb-3">üñºÔ∏è Inspiration & Gift Note</h3>
                        <!-- same as before -->
                    </div>
                    <div class="info-card">
                        <h3 class="text-lg font-semibold mb-3">üóìÔ∏è Key Dates & Codes</h3>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div><span class="font-medium">Date Submitted:</span> <span id="ov_submitted"></span></div>
                            <div><span class="font-medium">Event Date:</span> <span id="ov_event"></span></div>
                            <div><span class="font-medium">P/D Date:</span> <span id="ov_pickup"></span></div>
                            <div><span class="font-medium">Type:</span> <span id="ov_is_delivery" class="status-badge"></span></div>
                            <div><span class="font-medium">Consultation Requested:</span> <span id="ov_consultation"></span></div>
                            <div><span class="font-medium">Discount Code:</span> <span id="ov_discount_code"></span></div>
                            <div><span class="font-medium">Referral Code:</span> <span id="ov_referral_code"></span></div>
                        </div>
                    </div>
                </div>
                <div class="space-y-6">
                    <div class="info-card bg-white shadow-xl border-pink-200 border-2">
                        <h3 class="text-lg font-bold mb-3">üí∞ Estimated Totals</h3>
                        <div class="text-sm space-y-2">
                            <div class="flex justify-between"><span>Price/dozen:</span> <span id="t_price"></span></div>
                            <div class="flex justify-between"><span>Base Subtotal:</span> <span id="t_base"></span></div>
                            <div class="flex justify-between"><span>Consult Fee:</span> <span id="t_consult"></span></div>
                            <div class="flex justify-between"><span>Gift Note Fee:</span> <span id="t_gift"></span></div>
                            <div class="flex justify-between"><span>Delivery Fee:</span> <span id="t_delivery"></span></div>
                            <div class="flex justify-between"><span>Additional Fees:</span> <span id="t_adj_fees" class="text-green-700"></span></div>
                            <div class="flex justify-between"><span>Discounts:</span> <span id="t_adj_disc" class="text-red-700"></span></div>
                            <hr class="my-2"/>
                            <div class="font-extrabold text-xl flex justify-between">Total Due: <span id="t_total"></span></div>
                        </div>
                    </div>
                    <!-- customer & logistics same -->
                    <!-- adjustments same -->
                </div>
            </div>
        </div>
    </dialog>

    <script>
    // Supabase client (same)
    const SUPABASE_URL = 'https://zyntkwammltmjjvgelwg.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp5bnRrd2FtbWx0bWpqdmdlbHdnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MzkxNjYsImV4cCI6MjA3ODExNTE2Nn0.eLkkGBuSRNUd7P7mJT5Be-dsvVjGBZ9pkupQq6KGT9A';
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // auth, bootstrap, logout same

    // tables - add is_delivery to orders
    const tables = {
        // ... all other tables unchanged
        orders: { title:'Orders', table:'orders', cols:[
            // ... existing
            { key:'pickup_delivery_date', label:'Pick up or delivery date', type:'date', w:'18' },
            { key:'is_delivery', label:'Is Delivery', type:'checkbox', w:'12' },
            // ... rest
        ]},
        // ...
    };

    // ... all helpers same

    // computeTotals - add delivery
    function computeTotals(){
        const ppd = pricing?.price_per_dozen || 0;
        const consult = activeOrder?.consultation_requested ? (pricing?.consultation_fee||0) : 0;
        const gift = activeOrder?.gift_note ? (pricing?.gift_note_fee||0) : 0;
        const delivery = activeOrder?.is_delivery ? (pricing?.delivery_fee||0) : 0;
        const base = (Number(activeOrder?.cookie_amount_dzns||0) * ppd);
        const feeSum = adjustments.filter(a=>a.kind==='fee').reduce((s,a)=>s+a.amount,0);
        const discSum = adjustments.filter(a=>a.kind==='discount').reduce((s,a)=>s+a.amount,0);
        const total = base + consult + gift + delivery + feeSum - discSum;
        document.getElementById('t_price').textContent = money(ppd);
        document.getElementById('t_base').textContent = money(base);
        document.getElementById('t_consult').textContent = money(consult);
        document.getElementById('t_gift').textContent = money(gift);
        document.getElementById('t_delivery').textContent = money(delivery);
        document.getElementById('t_adj_fees').textContent = money(feeSum);
        document.getElementById('t_adj_disc').textContent = '- ' + money(discSum).replace('$', '$');
        document.getElementById('t_total').textContent = money(total);
    }

    // fillDrawer - add delivery type
    function fillDrawer(){
        // ... existing
        const isDelivery = !!activeOrder?.is_delivery;
        document.getElementById('ov_is_delivery').textContent = isDelivery ? 'Delivery' : 'Pickup';
        document.getElementById('ov_is_delivery').className = `status-badge ${isDelivery ? 'status-paid' : 'status-fulfilled'}`;
        // ... rest
        computeTotals();
    }

    // viewInvoice - prettier pink theme, delivery fee, clean layout
    document.getElementById('viewInvoice').addEventListener('click', ()=>{
        if (!activeOrder || !activeCustomer) return alert("Load order first");
        const delivery = activeOrder?.is_delivery ? (pricing?.delivery_fee || 0) : 0;
        const totalDue = document.getElementById('t_total').textContent;
        const lineItems = [
            { label: `Base Price (${activeOrder.cookie_amount_dzns || 0} dozen @ ${document.getElementById('t_price').textContent})`, amount: document.getElementById('t_base').textContent },
            ...(activeOrder.consultation_requested ? [{ label: 'Consultation Fee', amount: document.getElementById('t_consult').textContent }] : []),
            ...(activeOrder.gift_note ? [{ label: 'Gift Note Fee', amount: document.getElementById('t_gift').textContent }] : []),
            ...(activeOrder.is_delivery ? [{ label: 'Delivery Fee', amount: money(delivery) }] : []),
            ...adjustments.filter(a => a.kind === 'fee').map(a => ({ label: `${a.label} (Fee)`, amount: money(a.amount) })),
            ...adjustments.filter(a => a.kind === 'discount').map(a => ({ label: `${a.label} (Discount)`, amount: `-${money(a.amount)}` })),
        ];
        const invoiceId = `RR${activeOrder.id.toString().padStart(4,'0')}`;
        let invoiceContent = `
<html>
<head>
    <title>Invoice ${invoiceId}</title>
    <style>
        body{font-family:'Helvetica Neue',sans-serif;margin:0;padding:40px;background:#fdf2f8;color:#333}
        .box{max-width:800px;margin:auto;background:#fff;padding:40px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,0.1);}
        .header{display:flex;align-items:center;margin-bottom:30px;}
        .logo{width:80px;margin-right:20px;border-radius:8px;}
        h1{font-size:32px;color:#FFB6C1;margin:0;}
        .company{font-size:13px;color:#666;margin-top:8px;}
        .info{display:flex;justify-content:space-between;margin:30px 0;font-size:14px;}
        .bill-to strong{font-size:15px;color:#FFB6C1;}
        table{width:100%;border-collapse:collapse;margin:30px 0;}
        th{background:#fff1f2;padding:12px;text-align:left;font-weight:600;color:#d94682;}
        td{padding:12px;border-bottom:1px solid #fce7f3;}
        .total{font-weight:bold;font-size:18px;background:#fff1f2;}
        .amount{text-align:right;}
        .notes{margin-top:40px;padding-top:20px;border-top:1px dashed #FFB6C1;font-size:13px;color:#666;}
        @media print{.box{box-shadow:none;border:none;}}
    </style>
</head>
<body>
<div class="box">
    <div class="header">
        <img src="https://i.imgur.com/9XjYk8s.png" alt="Rebel Ribbon" class="logo">
        <div>
            <h1>Rebel Ribbon Invoice</h1>
            <div class="company">
                Rebel Ribbon<br>
                info@rebelribbon.com<br>
                210-239-7471
            </div>
        </div>
    </div>
    <div class="info">
        <div class="bill-to">
            <strong>Bill To</strong><br>
            ${customerName}<br>
            ${customerEmail}<br>
            ${customerAddress || 'N/A'}
        </div>
        <div style="text-align:right">
            Invoice ${invoiceId}<br>
            Date: ${new Date().toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'})}
        </div>
    </div>
    <table>
        <tr><th>Description</th><th class="amount">Amount</th></tr>
        ${lineItems.map(i=>`<tr><td>${i.label}</td><td class="amount">${i.amount}</td></tr>`).join('')}
        <tr class="total"><td>Total Due</td><td class="amount">${totalDue}</td></tr>
    </table>
    <div class="notes">
        Order Notes: ${activeOrder.design_notes || 'None'}<br><br>
        Payment Terms: Net 7 days. Pay via Venmo @rebelribbon or Zelle to info@rebelribbon.com
    </div>
</div>
<script>window.onload=()=>window.print();</script>
</body>
</html>`;
        const win = window.open('','_blank','width=900,height=900');
        win.document.write(invoiceContent);
        win.document.close();
    });

    // init
    bootstrap();
    </script>
</body>
</html>
