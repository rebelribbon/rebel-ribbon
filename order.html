<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rebel Ribbon - Order</title>
  <!-- Google Fonts: Playfair Display + Open Sans -->
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* Prevent horizontal scroll */
    html, body {
      overflow-x: hidden;
    }
    /* Base & Reset */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    :root {
      --heading-font: 'Playfair Display', serif;
      --body-font: 'Open Sans', sans-serif;
      --pink: #FFC0CB;
      --pink-soft: #fff7fa;
      --pink-border: #fbd6e3;
      --black: #000;
      --dark-gray: #333;
      --muted: #777;
      --border-subtle: #ececec;
      --bg-subtle: #fafafa;
    }
    body {
      font-family: var(--body-font);
      color: var(--dark-gray);
      background: #fff;
      line-height: 1.6;
    }
    a {
      text-decoration: none;
      color: inherit;
    }
    img {
      max-width: 100%;
      display: block;
    }

    /* Header & Navigation */
    header {
      background: #fff;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
    }
    .logo img {
      height: 50px;
    }
    nav ul {
      list-style: none;
      display: flex;
    }
    nav li {
      margin-left: 20px;
    }
    nav a {
      font-size: 16px;
      color: var(--black);
      font-family: var(--body-font);
      transition: color 0.3s;
    }
    nav a:hover {
      color: var(--pink);
      text-decoration: underline;
    }
    .hamburger {
      display: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--black);
      background: var(--pink);
      padding: 10px;
      border-radius: 50%;
      margin-left: auto;
      margin-right: 10px;
      width: 40px;
      height: 40px;
    }
    @media (max-width:768px) {
      header { padding: 15px; }
      nav ul {
        display: none;
        flex-direction: column;
        position: absolute;
        top: 70px;
        left: 0;
        right: 0;
        background: #fff;
        padding: 20px 0;
        text-align: center;
        z-index: 999;
      }
      nav li { margin: 10px 0; }
      .hamburger {
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
    }

    /* Hero Section */
    .hero {
      position: relative;
      height: 30vh;
      background: url('https://via.placeholder.com/1920x1080?text=Place+Your+Order') center/cover no-repeat;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    .hero::before {
      content: "";
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255,192,203,0.5);
    }
    .hero-content {
      position: relative;
      z-index: 1;
    }
    .hero h1 {
      font-size: 36px;
      color: var(--black);
      font-family: var(--heading-font);
      margin-bottom: 10px;
    }
    .hero p {
      font-size: 18px;
      color: var(--black);
      font-family: var(--body-font);
    }

    /* Content Section */
    .content-section {
      padding: 40px 16px 60px;
      max-width: 1000px;
      margin: 0 auto;
    }

    /* Order Form Styles */
    .order-form-wrapper {
      margin-top: 16px;
    }

    /* CENTERED header */
    .order-form-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 16px;
      text-align: center;
    }

    .order-form-title {
      font-family: var(--heading-font);
      font-size: 26px;
      letter-spacing: 0.02em;
      margin-bottom: 4px;
    }

    .order-form-subtitle {
      font-size: 14px;
      margin-top: 4px;
      color: var(--muted);
      max-width: 520px;
      margin-left: auto;
      margin-right: auto;
    }

    .order-form-badge {
      background: var(--pink-soft);
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      border: 1px solid var(--pink-border);
      color: var(--dark-gray);
      align-self: flex-start;
      white-space: nowrap;
    }

    form#orderForm {
      background: #fff;
      padding: 24px 22px 26px;
      border-radius: 18px;
      border: 1px solid var(--pink-border);
      box-shadow: 0 14px 35px rgba(0,0,0,0.06);
    }

    @media (max-width: 600px) {
      form#orderForm {
        padding: 20px 16px 22px;
        border-radius: 16px;
      }
    }

    .form-section {
      padding: 18px 16px 18px;
      border-radius: 14px;
      background: var(--bg-subtle);
      border: 1px solid var(--border-subtle);
      margin-bottom: 14px;
    }

    .form-section:nth-of-type(even) {
      background: #fff;
    }

    .form-section-heading-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .form-section-heading {
      font-family: var(--heading-font);
      font-size: 18px;
    }

    .form-section-caption {
      font-size: 12px;
      color: var(--muted);
    }

    .form-group {
      margin-bottom: 12px;
    }

    .form-group label {
      display: flex;
      align-items: center;
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 5px;
      gap: 6px;
    }

    .label-tag {
      font-size: 10px;
      padding: 3px 7px;
      border-radius: 999px;
      background: var(--pink-soft);
      border: 1px solid var(--pink-border);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--muted);
    }

    .form-group small {
      display: block;
      font-size: 11px;
      color: #666;
      margin-top: 2px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px 11px;
      border-radius: 999px;
      border: 1px solid #d2d2d2;
      font-family: var(--body-font);
      font-size: 14px;
      background: #fff;
      transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    }

    .form-group textarea {
      min-height: 80px;
      border-radius: 12px;
      resize: vertical;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--pink);
      box-shadow: 0 0 0 2px rgba(255,192,203,0.3);
      background: #fffdfd;
    }

    .inline-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    .inline-checkbox input[type="checkbox"] {
      width: auto;
      accent-color: var(--pink);
      transform: scale(1.1);
    }

    .inline-checkbox label {
      margin-bottom: 0;
      font-weight: 500;
    }

    .two-column {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }

    @media (max-width: 700px) {
      .two-column {
        grid-template-columns: 1fr;
      }
    }

    /* CENTERED form actions and button */
    .form-actions {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
      text-align: center;
    }

    .primary-button {
      padding: 13px 22px;
      border-radius: 999px;
      border: none;
      background: var(--pink);
      color: var(--black);
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      font-family: var(--body-font);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 10px 22px rgba(0,0,0,0.08);
      transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
      width: 100%;
      max-width: 260px;
      text-align: center;
    }

    .primary-button span.icon {
      font-size: 16px;
      line-height: 1;
    }

    .primary-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 26px rgba(0,0,0,0.12);
      background: #ffacc0;
    }

    .primary-button:active {
      transform: translateY(0);
      box-shadow: 0 8px 18px rgba(0,0,0,0.08);
    }

    .primary-button:disabled {
      opacity: 0.75;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .form-message {
      font-size: 13px;
      margin-top: 3px;
    }
    .form-message.error {
      color: #b00020;
    }
    .form-message.success {
      color: #0b7a2a;
    }

    /* Estimate box */
    .estimate-box {
      margin-top: 6px;
      padding: 12px 14px;
      border-radius: 10px;
      background: var(--pink-soft);
      border: 1px solid #ffe4ed;
      font-size: 14px;
      text-align: left;
    }
    .estimate-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
      gap: 8px;
      font-size: 13px;
    }
    .estimate-row span {
      white-space: nowrap;
    }
    .estimate-total {
      font-weight: 700;
      margin-top: 6px;
      border-top: 1px solid #f0c0d0;
      padding-top: 6px;
      font-size: 15px;
    }
    .estimate-note {
      font-size: 12px;
      margin-top: 6px;
      color: #555;
    }

    .secondary-button {
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--pink-border);
      background: #fff;
      color: var(--dark-gray);
      font-size: 12px;
      cursor: pointer;
      align-self: flex-start;
      margin-top: 5px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.15s ease, transform 0.12s ease, box-shadow 0.12s ease;
    }

    .secondary-button:hover {
      background: var(--pink-soft);
      transform: translateY(-0.5px);
      box-shadow: 0 6px 14px rgba(0,0,0,0.04);
    }

    .secondary-button span.icon {
      font-size: 14px;
      line-height: 1;
    }

    .code-message {
      font-size: 11px;
      margin-top: 3px;
      color: var(--muted);
    }

    /* Footer */
    footer {
      background: var(--pink);
      color: var(--black);
      padding: 30px 20px;
    }
    footer .footer-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: space-between;
    }
    footer .footer-section { flex: 1; min-width: 200px; }
    footer h3 {
      font-family: var(--heading-font);
      font-size: 18px;
      margin-bottom: 10px;
    }
    footer p, footer a {
      font-size: 14px;
      color: var(--black);
      font-family: var(--body-font);
    }
    footer a:hover { text-decoration: underline; }
    .footer-section.newsletter { text-align: left; }
    .newsletter iframe { width: 100%; border: 0; }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="logo">
      <img src="horizontaltrans.png" alt="Rebel Ribbon Logo">
    </div>
    <div class="hamburger" onclick="toggleMenu()">&#9776;</div>
    <nav>
      <ul class="nav-menu" id="navMenu">
        <li><a href="index.html">Home</a></li>
        <li><a href="about.html">About Us</a></li>
        <li><a href="ingredients.html">Ingredients</a></li>
        <li><a href="gallery.html">Gallery</a></li>
        <li><a href="contact.html">Contact</a></li>
        <li><a href="order.html">Order</a></li>
      </ul>
    </nav>
  </header>

  <!-- Hero Section for Order Page -->
  <section class="hero">
    <div class="hero-content">
      <h1>Place Your Order</h1>
      <p>Indulge in our handcrafted cookies, order now.</p>
    </div>
  </section>

  <!-- Order Form Section -->
  <section class="content-section">
    <div class="order-form-wrapper">
      <div class="order-form-header">
        <div>
          <h2 class="order-form-title">Start Your Custom Cookie Order</h2>
          <p class="order-form-subtitle">
            Fill out this form and we will follow up to confirm details, pricing, and availability.
          </p>
        </div>
      </div>

      <form id="orderForm" novalidate>
        <!-- Customer Info -->
        <div class="form-section">
          <div class="form-section-heading-row">
            <div class="form-section-heading">Your Info</div>
          </div>
          <div class="two-column">
            <div class="form-group">
              <label for="first_name">
                First Name
                <span class="label-tag">Required</span>
              </label>
              <input type="text" id="first_name" name="first_name" required autocomplete="given-name">
            </div>
            <div class="form-group">
              <label for="last_name">
                Last Name
                <span class="label-tag">Required</span>
              </label>
              <input type="text" id="last_name" name="last_name" required autocomplete="family-name">
            </div>
          </div>
          <div class="two-column">
            <div class="form-group">
              <label for="email">
                Email
                <span class="label-tag">Required</span>
              </label>
              <input type="email" id="email" name="email" required autocomplete="email">
            </div>
            <div class="form-group">
              <label for="phone">
                Phone
                <span class="label-tag">Required</span>
              </label>
              <input type="tel" id="phone" name="phone" required autocomplete="tel">
            </div>
          </div>
        </div>

        <!-- Delivery or Pickup Details -->
        <div class="two-column">
          <div class="form-group">
            <label for="pickup_delivery_type">
              Pickup or Delivery
              <span class="label-tag">Required</span>
            </label>
            <select id="pickup_delivery_type" name="pickup_delivery_type" required>
              <option value="">Select one</option>
              <option value="Pickup">Pickup</option>
              <option value="Delivery">Delivery</option>
            </select>
          </div>
          <div></div> <!-- empty cell to keep the grid balanced -->
        </div>

        <div class="two-column">
          <div class="form-group">
            <label for="pickup_delivery_date">
              Preferred Pickup or Delivery Date
              <span class="label-tag">Required</span>
            </label>
            <input type="date" id="pickup_delivery_date" name="pickup_delivery_date" required>
          </div>
          <div class="form-group">
            <label for="event_date">
              Event Date
              <span class="label-tag">Required</span>
            </label>
            <input type="date" id="event_date" name="event_date" required>
          </div>
        </div>

        <div id="addressFields" style="display:none; margin-top:8px;">
          <div class="form-group">
            <label for="street_address">
              Street Address (for delivery)
            </label>
            <input type="text" id="street_address" name="street_address" autocomplete="address-line1">
          </div>
          <div class="form-group">
            <label for="street_address_cont">
              Address Line 2
            </label>
            <input type="text" id="street_address_cont" name="street_address_cont" autocomplete="address-line2">
          </div>
          <div class="two-column">
            <div class="form-group">
              <label for="city">City</label>
              <input type="text" id="city" name="city" autocomplete="address-level2">
            </div>
            <div class="form-group">
              <label for="state">State</label>
              <input type="text" id="state" name="state" autocomplete="address-level1">
            </div>
          </div>
          <div class="form-group">
            <label for="zip">Zip Code</label>
            <input type="text" id="zip" name="zip" autocomplete="postal-code">
          </div>
        </div>

        <!-- Order Details -->
        <div class="form-section">
          <div class="form-section-heading-row">
            <div class="form-section-heading">Order Details</div>
          </div>
          <div class="two-column">
            <div class="form-group">
              <label for="event_type_name">
                Event Type / Name
                <span class="label-tag">Required</span>
              </label>
              <input
                type="text"
                id="event_type_name"
                name="event_type_name"
                required
                placeholder="Example: Baby shower, wedding, corporate event, birthday"
              >
            </div>
            <div class="form-group">
              <label for="cookie_amount_dzns">
                How Many Dozen Cookies
                <span class="label-tag">Required</span>
              </label>
              <input type="number" id="cookie_amount_dzns" name="cookie_amount_dzns" min="1" step="0.5" required>
            </div>
          </div>
          <div class="two-column">
            <div class="form-group">
              <label for="flavor">
                Flavor
                <span class="label-tag">Required</span>
              </label>
              <select id="flavor" name="flavor" required>
                <option value="">Loading flavors...</option>
              </select>
            </div>
            <div class="form-group">
              <label for="dietary_option">
                Dietary Option
                <span class="label-tag">Required</span>
              </label>
              <select id="dietary_option" name="dietary_option" required>
                <option value="">None</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="design_notes">
              Design Ideas and Notes
              <span class="label-tag">Required</span>
            </label>
            <textarea
              id="design_notes"
              name="design_notes"
              required
              placeholder="Theme, colors, names, phrases, must have details..."
            ></textarea>
          </div>
          <div class="form-group">
            <label for="design_inspiration_photo">
              Upload Inspiration Photo
              <span class="label-tag">Optional</span>
            </label>
            <input type="file" id="design_inspiration_photo" name="design_inspiration_photo" accept="image/*">
            <small>Upload a screenshot or inspiration picture.</small>
          </div>
        </div>

        <!-- Extras -->
        <div class="form-section">
          <div class="form-section-heading-row">
            <div class="form-section-heading">Extras</div>
          </div>
          <div class="form-group inline-checkbox">
            <input type="checkbox" id="gift_note" name="gift_note">
            <label for="gift_note">Add a gift note</label>
          </div>
          <div class="form-group" id="gift_note_text_group" style="display:none;">
            <label for="gift_note_text">
              Gift Note Text
            </label>
            <textarea id="gift_note_text" name="gift_note_text" placeholder="Short message to the recipient."></textarea>
          </div>
          <div class="form-group inline-checkbox">
            <input type="checkbox" id="consultation_requested" name="consultation_requested">
            <label for="consultation_requested">I would like a design consultation</label>
          </div>
        </div>

        <!-- Codes -->
        <div class="form-section">
          <div class="form-section-heading-row">
            <div class="form-section-heading">Discount and Referral</div>
          </div>
          <div class="two-column">
            <div class="form-group">
              <label for="discount_code_used">
                Discount Code
              </label>
              <input type="text" id="discount_code_used" name="discount_code_used" placeholder="If you have one">
              <button type="button" id="applyDiscountButton" class="secondary-button">
                <span class="icon">✓</span>
                Apply discount
              </button>
              <small id="discountHelp" class="code-message"></small>
            </div>
            <div class="form-group">
              <label for="referral_code_used">
                Referral Code
              </label>
              <input type="text" id="referral_code_used" name="referral_code_used" placeholder="Friend referral code if any">
              <button type="button" id="applyReferralButton" class="secondary-button">
                <span class="icon">♡</span>
                Apply referral
              </button>
              <small id="referralHelp" class="code-message"></small>
            </div>
          </div>
        </div>

        <!-- Estimated Total -->
        <div class="form-section">
          <div class="form-section-heading-row">
            <div class="form-section-heading">Estimated Total</div>
            <div class="form-section-caption">Based on your choices and our current menu pricing</div>
          </div>
          <div id="estimateBox" class="estimate-box">
            <div class="estimate-note">
              Enter your details above to see an estimated total. Final pricing, discounts, and tax are confirmed manually.
            </div>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button type="submit" id="submitButton" class="primary-button">
            <span>Submit Request</span>
          </button>
          <p id="formMessage" class="form-message"></p>
        </div>
      </form>
    </div>
  </section>

  <!-- Footer -->
  <footer>
    <div class="footer-content">
      <div class="footer-section">
        <h3>Contact Us</h3>
        <p>Email: <a href="mailto:info@rebelribbon.com">info@rebelribbon.com</a></p>
        <p>Phone: <a href="tel:2102397471">(210) 239-7471</a></p>
      </div>
      <div class="footer-section">
        <h3>Quick Links</h3>
        <p><a href="index.html">Home</a></p>
        <p><a href="about.html">About Us</a></p>
        <p><a href="ingredients.html">Ingredients</a></p>
        <p><a href="gallery.html">Gallery</a></p>
        <p><a href="contact.html">Contact</a></p>
        <p><a href="order.html">Order</a></p>
      </div>
      <div class="footer-section newsletter">
        <h3>Newsletter</h3>
        <!-- Tally Embed Code for Newsletter Signup -->
        <iframe data-tally-src="https://tally.so/embed/wokM7x?alignLeft=1&hideTitle=1&transparentBackground=1&dynamicHeight=1"
                loading="lazy" width="100%" height="157" frameborder="0" marginheight="0" marginwidth="0"
                title="News Letter"></iframe>
        <script>
          var d = document,
              w = "https://tally.so/widgets/embed.js",
              v = function(){
                if (typeof Tally !== "undefined") {
                  Tally.loadEmbeds();
                } else {
                  d.querySelectorAll("iframe[data-tally-src]:not([src])")
                   .forEach(function(e){ e.src = e.dataset.tallySrc; });
                }
              };
          if (typeof Tally !== "undefined") {
            v();
          } else if (!d.querySelector('script[src="'+w+'"]')) {
            var s = d.createElement("script");
            s.src = w;
            s.onload = v;
            s.onerror = v;
            d.body.appendChild(s);
          }
        </script>
      </div>
    </div>
  </footer>

  <!-- Supabase client -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // Supabase configuration
    const SUPABASE_URL = "https://zyntkwammltmjjvgelwg.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp5bnRrd2FtbWx0bWpqdmdlbHdnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MzkxNjYsImV4cCI6MjA3ODExNTE2Nn0.eLkkGBuSRNUd7P7mJT5Be-dsvVjGBZ9pkupQq6KGT9A";
    const { createClient } = supabase;
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    let currentPricing = null;
    // discount state
    let appliedDiscount = { type: null, amount: 0, label: "" };
    let appliedReferral = { type: null, amount: 0, label: "" };

    function formatMoney(amount) {
      if (isNaN(amount) || amount < 0) amount = 0;
      return "$" + amount.toFixed(2);
    }

    // helpers for IDs and referral codes
    function generateNumericId(length) {
      let result = "";
      for (let i = 0; i < length; i++) {
        result += Math.floor(Math.random() * 10).toString();
      }
      return result;
    }
    function generateReferralCode(firstName, lastName) {
      const firstPart = (firstName || "").trim().toUpperCase().slice(0, 3).padEnd(3, "X");
      const lastPart = (lastName || "").trim().toUpperCase().slice(0, 3).padEnd(3, "X");
      const numbers = generateNumericId(3);
      return firstPart + lastPart + numbers;
    }
    async function generateUniqueReferralCode(firstName, lastName) {
      let attempt = 0;
      while (attempt < 5) {
        const code = generateReferralCode(firstName, lastName);
        const { data, error } = await sb
          .from("referral_codes")
          .select("id")
          .eq("code", code)
          .limit(1);
        if (!error && (!data || data.length === 0)) {
          return code;
        }
        attempt++;
      }
      // fallback if collisions keep happening
      return "REF" + generateNumericId(6);
    }

    async function loadSelectOptions() {
      const flavorSelect = document.getElementById("flavor");
      const dietarySelect = document.getElementById("dietary_option");

      // Load flavors
      try {
        const { data: flavors, error: flavorError } = await sb
          .from("flavors")
          .select("name")
          .order("name", { ascending: true });

        flavorSelect.innerHTML = "";
        if (flavorError) {
          console.error("Error loading flavors", flavorError);
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "Select flavor";
          flavorSelect.appendChild(opt);
        } else if (flavors && flavors.length > 0) {
          const defaultOpt = document.createElement("option");
          defaultOpt.value = "";
          defaultOpt.textContent = "Select flavor";
          flavorSelect.appendChild(defaultOpt);
          flavors.forEach(f => {
            const opt = document.createElement("option");
            opt.value = f.name;
            opt.textContent = f.name;
            flavorSelect.appendChild(opt);
          });
        } else {
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "No flavors found";
          flavorSelect.appendChild(opt);
        }
      } catch (err) {
        console.error("Unexpected error loading flavors", err);
      }

      // Load dietary options
      try {
        const { data: dietaryOptions, error: dietaryError } = await sb
          .from("dietary_options")
          .select("name")
          .order("name", { ascending: true });

        dietarySelect.innerHTML = "";
        const noneOpt = document.createElement("option");
        noneOpt.value = "";
        noneOpt.textContent = "None";
        dietarySelect.appendChild(noneOpt);

        if (dietaryError) {
          console.error("Error loading dietary options", dietaryError);
        } else if (dietaryOptions && dietaryOptions.length > 0) {
          dietaryOptions.forEach(o => {
            const opt = document.createElement("option");
            opt.value = o.name;
            opt.textContent = o.name;
            dietarySelect.appendChild(opt);
          });
        }
      } catch (err) {
        console.error("Unexpected error loading dietary options", err);
      }
    }

    // debug version with console logs
    async function loadPricing() {
      const box = document.getElementById("estimateBox");
      try {
        const { data, error } = await sb
          .from("pricing")
          .select("price_per_dozen, delivery_fee, consultation_fee, gift_note_fee, rush_fee, created_at")
          .order("created_at", { ascending: false })
          .limit(1)
          .maybeSingle();

        console.log("[pricing] data:", data);
        console.log("[pricing] error:", error);

        if (error) {
          console.error("[pricing] error from Supabase:", error);
          currentPricing = null;
          if (box) {
            box.innerHTML = "<div class='estimate-note'>Pricing is not available right now. We will send your quote manually.</div>";
          }
          return;
        }

        if (!data) {
          console.warn("[pricing] no pricing row found");
          currentPricing = null;
          if (box) {
            box.innerHTML = "<div class='estimate-note'>Pricing is not available right now. We will send your quote manually.</div>";
          }
          return;
        }

        currentPricing = {
          price_per_dozen: Number(data.price_per_dozen || 0),
          delivery_fee: Number(data.delivery_fee || 0),
          consultation_fee: Number(data.consultation_fee || 0),
          gift_note_fee: Number(data.gift_note_fee || 0),
          rush_fee: Number(data.rush_fee || 0)
        };
        updateEstimate();
      } catch (err) {
        console.error("[pricing] unexpected JS error:", err);
        currentPricing = null;
        if (box) {
          box.innerHTML = "<div class='estimate-note'>Pricing is not available right now. We will send your quote manually.</div>";
        }
      }
    }

    function updateAddressVisibility() {
      const typeSelect = document.getElementById("pickup_delivery_type");
      const addressFields = document.getElementById("addressFields");
      if (!typeSelect || !addressFields) return;

      if (typeSelect.value === "Delivery") {
        addressFields.style.display = "block";
      } else {
        addressFields.style.display = "none";
        ["street_address","street_address_cont","city","state","zip"].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.value = "";
        });
      }
    }

    function getDaysFromToday(dateStr) {
      if (!dateStr) return null;
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const d = new Date(dateStr);
      d.setHours(0, 0, 0, 0);
      if (isNaN(d.getTime())) return null;
      const diffMs = d.getTime() - today.getTime();
      return Math.round(diffMs / 86400000);
    }

    function updateEstimate() {
      const box = document.getElementById("estimateBox");
      if (!box) return;
      if (!currentPricing) {
        box.innerHTML = "<div class='estimate-note'>Pricing is not available right now. We will send your quote manually.</div>";
        return;
      }

      const qtyInput = document.getElementById("cookie_amount_dzns");
      const pickupType = document.getElementById("pickup_delivery_type");
      const pickupDateInput = document.getElementById("pickup_delivery_date");
      const giftNoteCheckbox = document.getElementById("gift_note");
      const consultCheckbox = document.getElementById("consultation_requested");

      const dzns = qtyInput && qtyInput.value ? parseFloat(qtyInput.value) : 0;

      const pricePerDozen = parseFloat(currentPricing.price_per_dozen || 0);
      const deliveryFee = parseFloat(currentPricing.delivery_fee || 0);
      const consultFee = parseFloat(currentPricing.consultation_fee || 0);
      const giftNoteFee = parseFloat(currentPricing.gift_note_fee || 0);
      const rushFee = parseFloat(currentPricing.rush_fee || 0);

      const baseSubtotal = dzns > 0 ? dzns * pricePerDozen : 0;
      const deliveryCharge = pickupType && pickupType.value === "Delivery" ? deliveryFee : 0;
      const consultCharge = consultCheckbox && consultCheckbox.checked ? consultFee : 0;
      const giftCharge = giftNoteCheckbox && giftNoteCheckbox.checked ? giftNoteFee : 0;

      // Rush fee - pickup or delivery between 5 and 10 days from today
      let rushCharge = 0;
      if (pickupDateInput && pickupDateInput.value && rushFee > 0) {
        const daysOut = getDaysFromToday(pickupDateInput.value);
        if (daysOut !== null && daysOut >= 0 && daysOut <= 10) {
          rushCharge = rushFee;
        }
      }

      const totalBeforeDiscount = baseSubtotal + deliveryCharge + consultCharge + giftCharge + rushCharge;

      // discounts
      let discountTotal = 0;
      let discountLines = "";

      if (appliedDiscount && appliedDiscount.amount > 0) {
        let discountAmount = 0;
        if (appliedDiscount.type === "percent") {
          discountAmount = totalBeforeDiscount * (appliedDiscount.amount / 100);
        } else {
          discountAmount = appliedDiscount.amount;
        }
        discountTotal += discountAmount;
        discountLines += "<div class='estimate-row'><span>" +
          (appliedDiscount.label || "Discount") +
          "</span><span>-" + formatMoney(discountAmount) + "</span></div>";
      }

      if (appliedReferral && appliedReferral.amount > 0) {
        let referralAmount = 0;
        if (appliedReferral.type === "percent") {
          referralAmount = totalBeforeDiscount * (appliedReferral.amount / 100);
        } else {
          referralAmount = appliedReferral.amount;
        }
        discountTotal += referralAmount;
        discountLines += "<div class='estimate-row'><span>" +
          (appliedReferral.label || "Referral discount") +
          "</span><span>-" + formatMoney(referralAmount) + "</span></div>";
      }

      if (discountTotal > totalBeforeDiscount) {
        discountTotal = totalBeforeDiscount;
      }

      const totalAfterDiscount = totalBeforeDiscount - discountTotal;

      let html = "";
      html += "<div class='estimate-row'><span>Cookies (" +
        (dzns || 0) + " dozen @ " + formatMoney(pricePerDozen) + ")</span><span>" +
        formatMoney(baseSubtotal) + "</span></div>";
      html += "<div class='estimate-row'><span>Delivery</span><span>" +
        formatMoney(deliveryCharge) + "</span></div>";
      html += "<div class='estimate-row'><span>Consultation</span><span>" +
        formatMoney(consultCharge) + "</span></div>";
      html += "<div class='estimate-row'><span>Gift note</span><span>" +
        formatMoney(giftCharge) + "</span></div>";
      html += "<div class='estimate-row'><span>Rush fee</span><span>" +
        formatMoney(rushCharge) + "</span></div>";
      html += "<div class='estimate-row'><span>Subtotal before discounts</span><span>" +
        formatMoney(totalBeforeDiscount) + "</span></div>";
      if (discountLines) {
        html += discountLines;
      }
      html += "<div class='estimate-total'><span>Estimated Total: </span><span>" +
        formatMoney(totalAfterDiscount) + "</span></div>";
      html += "<div class='estimate-note'>This is an estimate based on current menu pricing.</div>";
      box.innerHTML = html;
    }

    async function applyDiscount() {
      const discountHelp = document.getElementById("discountHelp");
      const discountCode = document.getElementById("discount_code_used").value.trim();
      const email = document.getElementById("email").value.trim();

      appliedDiscount = { type: null, amount: 0, label: "" };
      if (discountHelp) discountHelp.textContent = "";

      if (!discountCode) {
        if (discountHelp) discountHelp.textContent = "Enter a discount code to apply.";
        updateEstimate();
        return;
      }

      const today = new Date().toISOString().slice(0, 10);
      let messages = [];

      try {
        const { data: disc, error: discError } = await sb
          .from("discount_codes")
          .select("*")
          .eq("code", discountCode)
          .maybeSingle();

        console.log("[discount] data:", disc);
        console.log("[discount] error:", discError);

        if (discError) {
          messages.push("Error checking discount code. Please try again.");
        } else if (!disc) {
          messages.push("Discount code not found.");
        } else {
          let valid = true;

          if (disc.good_through_date && disc.good_through_date < today) {
            valid = false;
            messages.push("Discount code is expired.");
          }
          if (disc.email_allowed && email &&
              disc.email_allowed.toLowerCase() !== email.toLowerCase()) {
            valid = false;
            messages.push("Discount code is not valid for this email.");
          }
          if (disc.uses_allowed && disc.uses_allowed > 0 &&
              disc.uses_count >= disc.uses_allowed) {
            valid = false;
            messages.push("Discount code has already been used up.");
          }

          if (valid) {
            const typeRaw = (disc.type || "").toLowerCase();
            const amountNum = Number(disc.amount || 0);
            if (amountNum > 0) {
              if (typeRaw === "percent" || typeRaw === "percentage") {
                appliedDiscount = {
                  type: "percent",
                  amount: amountNum,
                  label: "Discount (" + discountCode + " - " + amountNum + "%)"
                };
              } else {
                appliedDiscount = {
                  type: "amount",
                  amount: amountNum,
                  label: "Discount (" + discountCode + ")"
                };
              }
              messages.push("Discount code applied.");
            } else {
              messages.push("Discount code has no discount amount configured.");
            }
          }
        }
      } catch (err) {
        console.error("Error validating discount code", err);
        messages.push("Unexpected error while validating discount code. Please try again.");
      }

      if (discountHelp) {
        discountHelp.textContent = messages.join(" ");
      }
      updateEstimate();
    }

    async function applyReferral() {
      const referralHelp = document.getElementById("referralHelp");
      const referralCode = document.getElementById("referral_code_used").value.trim();

      appliedReferral = { type: null, amount: 0, label: "" };
      if (referralHelp) referralHelp.textContent = "";

      if (!referralCode) {
        if (referralHelp) referralHelp.textContent = "Enter a referral code to apply.";
        updateEstimate();
        return;
      }

      const today = new Date().toISOString().slice(0, 10);
      let messages = [];

      try {
        const { data: ref, error: refError } = await sb
          .from("referral_codes")
          .select("*")
          .eq("code", referralCode)
          .maybeSingle();

        console.log("[referral] data:", ref);
        console.log("[referral] error:", refError);

        if (refError) {
          messages.push("Error checking referral code. Please try again.");
        } else if (!ref) {
          messages.push("Referral code not found.");
        } else {
          let validRef = true;

          if (ref.good_through_date && ref.good_through_date < today) {
            validRef = false;
            messages.push("Referral code is expired.");
          }

          if (validRef) {
            const refPercent = Number(ref.referee_discount || 0);
            if (refPercent > 0) {
              appliedReferral = {
                type: "percent",
                amount: refPercent,
                label: "Referral (" + referralCode + " - " + refPercent + "%)"
              };
              messages.push("Referral code applied.");
            } else {
              messages.push("Referral code has no discount configured.");
            }
          }
        }
      } catch (err) {
        console.error("Error validating referral code", err);
        messages.push("Unexpected error while validating referral code. Please try again.");
      }

      if (referralHelp) {
        referralHelp.textContent = messages.join(" ");
      }
      updateEstimate();
    }

    async function handleOrderSubmit(event) {
      event.preventDefault();
      const submitButton = document.getElementById("submitButton");
      const messageEl = document.getElementById("formMessage");

      messageEl.textContent = "";
      messageEl.className = "form-message";

      // Always required fields
      const requiredIds = [
        "first_name",
        "last_name",
        "email",
        "phone",
        "pickup_delivery_type",
        "pickup_delivery_date",
        "event_date",
        "event_type_name",
        "cookie_amount_dzns",
        "flavor",
        "design_notes"
      ];

      let missing = [];
      requiredIds.forEach(id => {
        const el = document.getElementById(id);
        if (el && !el.value.trim()) {
          missing.push(id);
        }
      });

      const pickupTypeVal = document.getElementById("pickup_delivery_type").value;

      // Address required only if Delivery is selected
      if (pickupTypeVal === "Delivery") {
        ["street_address", "city", "state", "zip"].forEach(id => {
          const el = document.getElementById(id);
          if (el && !el.value.trim()) {
            missing.push(id);
          }
        });
      }

      // Gift note text required if gift note is checked
      const giftNoteCheckbox = document.getElementById("gift_note");
      const giftNoteTextEl = document.getElementById("gift_note_text");

      if (giftNoteCheckbox && giftNoteCheckbox.checked) {
        if (!giftNoteTextEl.value.trim()) {
          missing.push("gift_note_text");
        }
      }

      // Inspiration photo, discount_code_used, referral_code_used are intentionally not required
      if (missing.length > 0) {
        messageEl.textContent = "Please fill in all required fields.";
        messageEl.classList.add("error");
        return;
      }

      // Extra date rules
      const pickup_delivery_date = document.getElementById("pickup_delivery_date").value;
      const event_date_value = document.getElementById("event_date").value;

      // Pickup date must be at least 5 days from today
      if (pickup_delivery_date) {
        const pickupDateObj = new Date(pickup_delivery_date);
        const minPickup = new Date();
        minPickup.setHours(0, 0, 0, 0);
        minPickup.setDate(minPickup.getDate() + 4);

        if (isNaN(pickupDateObj.getTime()) || pickupDateObj < minPickup) {
          messageEl.textContent = "Pickup or delivery date must be at least 5 days from today.";
          messageEl.classList.add("error");
          return;
        }
      } else {
        messageEl.textContent = "Please select a pickup or delivery date.";
        messageEl.classList.add("error");
        return;
      }

      // Event date rules - at least 5 days from today and not before pickup or delivery date
      if (event_date_value) {
        const eventDateObj = new Date(event_date_value);
        const pickupDateObj = new Date(pickup_delivery_date);
        const minEvent = new Date();
        minEvent.setHours(0, 0, 0, 0);
        minEvent.setDate(minEvent.getDate() + 4);

        if (isNaN(eventDateObj.getTime()) || eventDateObj < minEvent) {
          messageEl.textContent = "Event date must be at least 5 days from today.";
          messageEl.classList.add("error");
          return;
        }
        if (!isNaN(eventDateObj.getTime()) && !isNaN(pickupDateObj.getTime()) && eventDateObj < pickupDateObj) {
          messageEl.textContent = "Event date cannot be before the pickup or delivery date.";
          messageEl.classList.add("error");
          return;
        }
      } else {
        messageEl.textContent = "Please select an event date.";
        messageEl.classList.add("error");
        return;
      }

      submitButton.disabled = true;
      submitButton.textContent = "Submitting...";

      try {
        // Customer values
        const first_name = document.getElementById("first_name").value.trim();
        const last_name = document.getElementById("last_name").value.trim();
        const email = document.getElementById("email").value.trim();
        const phone = document.getElementById("phone").value.trim();
        const street_address = document.getElementById("street_address").value.trim();
        const street_address_cont = document.getElementById("street_address_cont").value.trim();
        const city = document.getElementById("city").value.trim();
        const state = document.getElementById("state").value.trim();
        const zip = document.getElementById("zip").value.trim();

        // Generate IDs
        const generatedCustomerId = generateNumericId(7);
        const generatedOrderId = generateNumericId(9);

        // Order values
        const pickup_delivery_type = pickupTypeVal;
        const event_date = event_date_value || null;
        const event_type_name = document.getElementById("event_type_name").value.trim();
        const cookie_amount_dzns = parseFloat(document.getElementById("cookie_amount_dzns").value);
        const flavor = document.getElementById("flavor").value;
        const dietary_option = document.getElementById("dietary_option").value || null;
        const design_notes = document.getElementById("design_notes").value.trim();
        const gift_note = giftNoteCheckbox.checked;
        const gift_note_text_raw = giftNoteTextEl.value.trim();
        const gift_note_text = gift_note ? (gift_note_text_raw || null) : null;
        const consultation_requested = document.getElementById("consultation_requested").checked;
        const discount_code_used = document.getElementById("discount_code_used").value.trim() || null;
        const referral_code_used = document.getElementById("referral_code_used").value.trim() || null;

        if (isNaN(cookie_amount_dzns) || cookie_amount_dzns <= 0) {
          throw new Error("Please enter a valid number of dozens.");
        }

        // File upload handling for inspiration photo (optional)
        const inspirationFileInput = document.getElementById("design_inspiration_photo");
        let design_inspiration_photo = null;

        if (inspirationFileInput && inspirationFileInput.files.length > 0) {
          const file = inspirationFileInput.files[0];
          const fileExt = file.name.split(".").pop();
          const filePath = "inspirations/" + crypto.randomUUID() + "." + fileExt;

          const { data: uploadData, error: uploadError } = await sb
            .storage
            .from("order_uploads")
            .upload(filePath, file);

          if (uploadError) {
            console.error(uploadError);
            throw new Error("Unable to upload inspiration photo.");
          }

          const { data: urlData } = sb
            .storage
            .from("order_uploads")
            .getPublicUrl(filePath);

          design_inspiration_photo = urlData.publicUrl;
        }

        // Find or create customer by email
        let customerId = null;
        const { data: existingCustomers, error: customerLookupError } = await sb
          .from("customers")
          .select("id")
          .eq("email", email);

        if (customerLookupError) {
          console.error("Customer lookup error", customerLookupError);
          throw new Error("There was a problem looking up your customer record.");
        }

        if (existingCustomers && existingCustomers.length > 0) {
          customerId = existingCustomers[0].id;
        } else {
          const { data: newCustomer, error: newCustomerError } = await sb
            .from("customers")
            .insert([
              {
                first_name,
                last_name,
                email,
                phone,
                street_address,
                street_address_cont,
                city,
                state,
                zip,
                customer_id: generatedCustomerId
              }
            ])
            .select("id")
            .single();

          if (newCustomerError) {
            console.error("Customer insert error", newCustomerError);
            throw new Error("There was a problem creating your customer record.");
          }
          customerId = newCustomer.id;
        }

        // Create and attach referral code for this customer
        try {
          const referralCode = await generateUniqueReferralCode(first_name, last_name);
          const { error: referralInsertError } = await sb
            .from("referral_codes")
            .insert([
              {
                code: referralCode,
                associated_customer_id: customerId
              }
            ]);

          if (referralInsertError) {
            console.error("Referral insert error", referralInsertError);
          }
        } catch (refErr) {
          console.error("Unexpected referral creation error", refErr);
        }

        // Insert order
        const { data: newOrder, error: orderError } = await sb
          .from("orders")
          .insert([
            {
              order_id: generatedOrderId,
              customer_id: customerId,
              pickup_delivery_date,
              event_date,
              cookie_amount_dzns,
              flavor,
              dietary_option,
              design_notes,
              design_inspiration_photo,
              gift_note,
              gift_note_text,
              consultation_requested,
              discount_code_used,
              referral_code_used,
              event_type_name,
              pickup_delivery_type,
              status: "In Review"
            }
          ])
          .select("id, order_id")
          .maybeSingle();

        if (orderError) {
          console.error("Order insert error full", JSON.stringify(orderError, null, 2));
          throw new Error("There was a problem saving your order. Please try again or contact us directly.");
        }

        // Optional rush fee adjustment entry
        if (newOrder && newOrder.id && currentPricing && currentPricing.rush_fee > 0) {
          const daysOut = getDaysFromToday(pickup_delivery_date);
          if (daysOut !== null && daysOut >= 0 && daysOut <= 10) {
            const adj = {
              order_id: newOrder.id,
              label: "Rush fee",
              amount: currentPricing.rush_fee,
              kind: "fee"
            };
            try {
              await sb.from("order_adjustments").insert([adj]);
            } catch (adjErr) {
              console.error("Order adjustment insert error", adjErr);
            }
          }
        }

        messageEl.textContent = "Thank you. Your request has been submitted. We will contact you to confirm details.";
        messageEl.classList.add("success");
        document.getElementById("orderForm").reset();
        document.getElementById("gift_note_text_group").style.display = "none";
        appliedDiscount = { type: null, amount: 0, label: "" };
        appliedReferral = { type: null, amount: 0, label: "" };
        updateAddressVisibility();
        updateEstimate();

        setTimeout(() => {
          window.location.href = "https://rebelribbon.com/thanks.html";
        }, 2000);
      } catch (err) {
        console.error(err);
        messageEl.textContent = err.message || "Something went wrong. Please try again or contact us directly.";
        messageEl.classList.add("error");
      } finally {
        submitButton.disabled = false;
        submitButton.textContent = "Submit Request";
      }
    }

    document.addEventListener("DOMContentLoaded", function() {
      loadSelectOptions();
      loadPricing();

      const pickupDateInput = document.getElementById("pickup_delivery_date");
      const eventDateInput = document.getElementById("event_date");

      // Base min date (today + 5 days)
      const baseMin = new Date();
      baseMin.setHours(0, 0, 0, 0);
      baseMin.setDate(baseMin.getDate() + 5);
      const yyyy = baseMin.getFullYear();
      const mm = String(baseMin.getMonth() + 1).padStart(2, "0");
      const dd = String(baseMin.getDate()).padStart(2, "0");
      const baseMinStr = yyyy + "-" + mm + "-" + dd;

      if (pickupDateInput) {
        pickupDateInput.min = baseMinStr;
        pickupDateInput.addEventListener("change", function() {
          // Adjust event date min to be max(baseMin, pickup date)
          if (eventDateInput && pickupDateInput.value) {
            const pickupStr = pickupDateInput.value;
            const pickupDateObj = new Date(pickupStr);
            pickupDateObj.setHours(0, 0, 0, 0);

            const maxMinDate = pickupDateObj.getTime() > baseMin.getTime() ? pickupDateObj : baseMin;
            const yyyy2 = maxMinDate.getFullYear();
            const mm2 = String(maxMinDate.getMonth() + 1).padStart(2, "0");
            const dd2 = String(maxMinDate.getDate()).padStart(2, "0");
            eventDateInput.min = yyyy2 + "-" + mm2 + "-" + dd2;
          }
          updateEstimate();
        });
        pickupDateInput.addEventListener("input", updateEstimate);
      }

      if (eventDateInput) {
        // Initial min for event date at load
        eventDateInput.min = baseMinStr;
      }

      const giftNoteCheckbox = document.getElementById("gift_note");
      const giftNoteTextGroup = document.getElementById("gift_note_text_group");
      if (giftNoteCheckbox) {
        giftNoteCheckbox.addEventListener("change", function() {
          giftNoteTextGroup.style.display = this.checked ? "block" : "none";
          updateEstimate();
        });
      }

      const pickupTypeSelect = document.getElementById("pickup_delivery_type");
      if (pickupTypeSelect) {
        pickupTypeSelect.addEventListener("change", function() {
          updateAddressVisibility();
          updateEstimate();
        });
        updateAddressVisibility();
      }

      const qtyInput = document.getElementById("cookie_amount_dzns");
      if (qtyInput) {
        qtyInput.addEventListener("input", updateEstimate);
        qtyInput.addEventListener("change", updateEstimate);
      }

      const consultCheckbox = document.getElementById("consultation_requested");
      if (consultCheckbox) {
        consultCheckbox.addEventListener("change", updateEstimate);
      }

      const applyDiscountButton = document.getElementById("applyDiscountButton");
      if (applyDiscountButton) {
        applyDiscountButton.addEventListener("click", applyDiscount);
      }

      const applyReferralButton = document.getElementById("applyReferralButton");
      if (applyReferralButton) {
        applyReferralButton.addEventListener("click", applyReferral);
      }

      const form = document.getElementById("orderForm");
      if (form) {
        form.addEventListener("submit", handleOrderSubmit);
      }

      updateEstimate();
    });

    function toggleMenu() {
      var menu = document.getElementById('navMenu');
      var currentDisplay = window.getComputedStyle(menu).display;
      if (currentDisplay === 'none') {
        menu.style.display = 'flex';
        menu.style.flexDirection = 'column';
      } else {
        menu.style.display = 'none';
      }
    }
  </script>
</body>
</html>
