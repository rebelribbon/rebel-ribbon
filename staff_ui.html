<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rebel Ribbon Staff UI</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .card { max-width: 520px; }
    .hidden { display: none; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen flex items-center justify-center p-4">

  <!-- Sign in card -->
  <div id="signinCard" class="card w-full rounded-2xl bg-white shadow p-6">
    <h1 class="text-2xl font-semibold mb-2">Rebel Ribbon Staff Sign in</h1>
    <p class="text-sm text-gray-600 mb-6">
      Use your @rebelribbon.com email. We will send a magic link.
    </p>

    <label class="block text-sm mb-1" for="email">Email</label>
    <input id="email" type="email" class="w-full border rounded-lg px-3 py-2 mb-4" placeholder="you@rebelribbon.com" />

    <button id="sendLink" class="w-full bg-blue-600 text-white rounded-lg px-4 py-2 font-medium">
      Send magic link
    </button>

    <p id="msg" class="text-sm mt-3 text-gray-700"></p>
    <p id="err" class="text-sm mt-3 text-red-700"></p>

    <p class="text-xs text-gray-500 mt-6">
      If the button does nothing, set SUPABASE_URL and SUPABASE_ANON_KEY in this file.
    </p>
  </div>

  <!-- App card (shown after login) -->
  <div id="appCard" class="card w-full rounded-2xl bg-white shadow p-6 hidden">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-semibold">Rebel Ribbon Admin</h2>
      <button id="signOut" class="text-sm border rounded-lg px-3 py-1">Sign out</button>
    </div>

    <p class="text-sm text-gray-700 mb-4">
      Signed in as <span id="who"></span>
    </p>

    <div class="grid gap-3">
      <a class="block text-center border rounded-lg px-4 py-2 hover:bg-gray-50"
         href="admin.html">Open Admin UI</a>
      <a class="block text-center border rounded-lg px-4 py-2 hover:bg-gray-50"
         href="order.html">Public Order Form</a>
    </div>

    <p class="text-xs text-gray-500 mt-6">
      If Admin UI shows “Failed to fetch”, verify your keys in that file and that RLS allows the authenticated role.
    </p>
  </div>

<script>
  // ===== 1) Config: set these two lines =====
  const SUPABASE_URL = 'https://zyntkwammltmjjvgelwg.supabase.co';
  const SUPABASE_ANON_KEY = 'PASTE_YOUR_ANON_KEY_HERE';
  // ===========================================

  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const signinCard = document.getElementById('signinCard');
  const appCard = document.getElementById('appCard');
  const emailInput = document.getElementById('email');
  const sendBtn = document.getElementById('sendLink');
  const msg = document.getElementById('msg');
  const err = document.getElementById('err');
  const who = document.getElementById('who');
  const signOutBtn = document.getElementById('signOut');

  // Your GitHub Pages URL for redirect
  const PAGES_BASE = 'https://rebelribbon.github.io/rebel-ribbon';
  const REDIRECT_TO = `${PAGES_BASE}/staff_ui.html`;

  // Simple domain guard
  function isAllowedEmail(e) {
    return typeof e === 'string' && e.toLowerCase().endsWith('@rebelribbon.com');
  }

  function showSignedIn(userEmail) {
    who.textContent = userEmail || '(unknown)';
    signinCard.classList.add('hidden');
    appCard.classList.remove('hidden');
  }

  function showSignedOut() {
    appCard.classList.add('hidden');
    signinCard.classList.remove('hidden');
  }

  async function refreshSessionUI() {
    const { data: { session } } = await sb.auth.getSession();
    if (session && session.user) {
      showSignedIn(session.user.email);
    } else {
      showSignedOut();
    }
  }

  // 2) Handle magic link delivery
  sendBtn.addEventListener('click', async () => {
    msg.textContent = '';
    err.textContent = '';

    const email = emailInput.value.trim();
    if (!isAllowedEmail(email)) {
      err.textContent = 'Use your @rebelribbon.com address.';
      return;
    }

    sendBtn.disabled = true;
    sendBtn.textContent = 'Sending...';

    try {
      const { error } = await sb.auth.signInWithOtp({
        email,
        options: {
          emailRedirectTo: REDIRECT_TO
        }
      });
      if (error) throw error;
      msg.textContent = 'Check your email for the magic link.';
    } catch (e) {
      err.textContent = e.message || 'Failed to fetch';
    } finally {
      sendBtn.disabled = false;
      sendBtn.textContent = 'Send magic link';
    }
  });

  // 3) Handle the return from the magic link
  // Supabase places access_token etc in the hash. This will exchange it for a session.
  (async function handleHash() {
    // Supabase v2 handles it internally on getSession, but we also nudge it by reading the URL
    try {
      const hash = window.location.hash || '';
      if (hash.includes('access_token') || hash.includes('error')) {
        // Supabase auto-parses on first auth call
        const { data: { session }, error } = await sb.auth.getSession();
        if (error) throw error;
        if (session && session.user) {
          // Clean the hash so refresh does not re-parse
          history.replaceState({}, document.title, window.location.pathname);
        }
      }
    } catch (e) {
      console.error(e);
    }
  })();

  // 4) Sign out
  signOutBtn.addEventListener('click', async () => {
    await sb.auth.signOut();
    showSignedOut();
  });

  // 5) Initial
  refreshSessionUI();
</script>
</body>
</html>
